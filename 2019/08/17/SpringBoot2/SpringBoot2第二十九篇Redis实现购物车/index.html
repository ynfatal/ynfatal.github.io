<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


















  
  
  <link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css">







<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.1.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.1.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":true,"dimmer":false},
    back2top: true,
    back2top_sidebar: true,
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Redis 是一个高性能的 key-value数据库。它有五种数据类型，分别为 string（字符串）、list（列表）、set（集合）、zset（有序集合）、hash（哈希表），这些数据类型的所有操作都是原子性的。由于 Redis 有多种数据类型，而且性能特别高，所以能用的场景也很多，包括购物车。   注意：Redis是使用 ANSI C语言编写的，ANSI 是一种基于ASCII扩充的编码字符集">
<meta name="keywords" content="SpringBoot2,Redis">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringBoot2 | 第二十九篇：Redis 实现购物车">
<meta property="og:url" content="https://ynfatal.github.io/2019/08/17/SpringBoot2/SpringBoot2第二十九篇Redis实现购物车/index.html">
<meta property="og:site_name" content="Fatal&#39;s Blog">
<meta property="og:description" content="Redis 是一个高性能的 key-value数据库。它有五种数据类型，分别为 string（字符串）、list（列表）、set（集合）、zset（有序集合）、hash（哈希表），这些数据类型的所有操作都是原子性的。由于 Redis 有多种数据类型，而且性能特别高，所以能用的场景也很多，包括购物车。   注意：Redis是使用 ANSI C语言编写的，ANSI 是一种基于ASCII扩充的编码字符集">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1591416070225.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590934870261.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1591516587177.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590935210388.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1566196424378.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1566196407427.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590935412948.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590935518869.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590922792410.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1566402745570.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590935676206.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1566402980408.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590935762300.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1566197174800.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590935982070.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590936038160.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590936092745.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590936365922.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590936436068.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590936489208.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1566197287007.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590936664436.png">
<meta property="og:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1591508385302.png">
<meta property="og:updated_time" content="2020-05-31T04:12:10.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SpringBoot2 | 第二十九篇：Redis 实现购物车">
<meta name="twitter:description" content="Redis 是一个高性能的 key-value数据库。它有五种数据类型，分别为 string（字符串）、list（列表）、set（集合）、zset（有序集合）、hash（哈希表），这些数据类型的所有操作都是原子性的。由于 Redis 有多种数据类型，而且性能特别高，所以能用的场景也很多，包括购物车。   注意：Redis是使用 ANSI C语言编写的，ANSI 是一种基于ASCII扩充的编码字符集">
<meta name="twitter:image" content="https://ynfatal.github.io/images/SpringBoot2/SpringBoot使用Redis实现购物车/1591416070225.png">





  
  
  <link rel="canonical" href="https://ynfatal.github.io/2019/08/17/SpringBoot2/SpringBoot2第二十九篇Redis实现购物车/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>SpringBoot2 | 第二十九篇：Redis 实现购物车 | Fatal's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


  <!-- 代码块复制功能，本版本本来就有，我竟然不知道。无语 -->
  <!-- <script src="https://code.jquery.com/jquery-3.0.0.min.js"></script>
  <script type="text/javascript" src="/js/src/clipboard.min.js"></script>  
  <script type="text/javascript" src="/js/src/clipboard-use.js"></script> -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Fatal's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">Attitude decides everything</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags<span class="badge">30</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories<span class="badge">8</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">49</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-links">

    
    
    
      
    

    
      
    

    <a href="/links/" rel="section"><i class="menu-item-icon fa fa-fw fa-link"></i> <br>Links</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    
  
  

  

  <a href="https://github.com/ynfatal" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ynfatal.github.io/2019/08/17/SpringBoot2/SpringBoot2第二十九篇Redis实现购物车/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fatal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fatal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">SpringBoot2 | 第二十九篇：Redis 实现购物车

              
            
          </h1>
        

        <div class="post-meta">
        
          

          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-08-17 20:42:10" itemprop="dateCreated datePublished" datetime="2019-08-17T20:42:10+08:00">2019-08-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-05-31 12:12:10" itemprop="dateModified" datetime="2020-05-31T12:12:10+08:00">2020-05-31</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/SpringBoot2/" itemprop="url" rel="index"><span itemprop="name">SpringBoot2</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><code>Redis</code> 是一个高性能的 <code>key-value</code>数据库。它有五种数据类型，分别为 <code>string</code>（字符串）、<code>list</code>（列表）、<code>set</code>（集合）、<code>zset</code>（有序集合）、<code>hash</code>（哈希表），这些数据类型的所有操作都是原子性的。由于 <code>Redis</code> 有多种数据类型，而且性能特别高，所以能用的场景也很多，包括<strong>购物车</strong>。</p>
<blockquote>
<p> 注意：<code>Redis</code>是使用 <code>ANSI</code> <a href="https://baike.baidu.com/item/C%E8%AF%AD%E8%A8%80" target="_blank" rel="noopener">C语言</a>编写的，ANSI 是一种基于<code>ASCII</code>扩充的编码字符集。以下说 32 字节，在这里可以放 32 个字母。</p>
</blockquote>
<p>[TOC]</p>
<h2 id="为什么选择-Redis-做购物车？"><a href="#为什么选择-Redis-做购物车？" class="headerlink" title="为什么选择 Redis 做购物车？"></a>为什么选择 Redis 做购物车？</h2><p>​        存储<code>购物车</code>当然得使用数据库，数据库分为<code>关系型数据库</code>（这里用 <code>Mysql</code>）和<code>非关系型数据库</code>（这里用 <code>Redis</code>），我们应该怎样选择？</p>
<p>​        我们先从购物车Item的<code>数据模型</code>说起，百度了一下，网上的很多方案，大部分都有一个缺点，就是将<strong><code>Sku</code>图片等等属于<code>Sku</code>的数据</strong>（以下称为“<strong>共有数据</strong>”；在他们的数据库设计中，这些字段都属于<strong>冗余</strong>字段）放在购物车Item的<code>数据模型</code>中，购物车每加入一个商品，都会有这些重复的数据；如果有一万个用户的购物车都有<strong>这种<code>Sku</code></strong>，那么这些<strong>共有数据</strong>将会重复 <strong>9999</strong> 次。那如果还有<strong>一万</strong>种<code>Sku</code>呢？那数据库岂不是存放了<strong>大量</strong>的垃圾数据！这只是缺点之一。如果你也这么做的话，那你应该会发现，购物车这个模块，你还不能很好的使用 <code>cache</code>（可以参考后面的<strong>方案对比</strong>）。他们设计这样的<code>数据模型</code>不仅<strong>浪费</strong>数据库<strong>空间</strong>，而且<strong>性能</strong>上也<strong>不怎么样</strong>（以查询 <code>mysql</code> 和查询 <code>redis</code> 做对比）。</p>
<p>​         那么，既然是 <strong>共有数据</strong>，我们就应该考虑重复使用，购物车Item的话，数据模型可以包括五部分：<code>用户ID</code>，<code>SkuID</code>，<code>店铺ID</code>，<code>商品数量</code>，<code>加入购物车时间</code>，这些数据都是购物车的核心。其中，<code>加入购物车时间</code>是为了展示的时候按照时间排序，最新的排在前面。那些需要展示的<strong>共有数据</strong>，我们则是从 <code>sku</code> 的<strong>cache</strong> 中取；查询购物车列表的时候，我们也可以约定每次下拉刷新 <strong>16</strong> 条记录，然后通过遍历的方式从缓存中拿到这 <strong>16</strong> 条需要展示的数据。这种方式是不是<strong>性能更好</strong>，可以<strong>大大地减少</strong> <code>mysql</code> 的<strong>负担</strong>。当然，我们系统的 <code>mysql</code> 一般都存储了很多数据，忍辱负重，购物车当然可以存放在 <code>mysql</code> 中，但这样做如果用户太多，对 <code>mysql</code>多少还是有些压力 。那如果我们选择将购物车放在 <code>Redis</code> 中呢？从性能上讲，是不是达到了最优的策略？！😆 </p>
<h3 id="方案对比"><a href="#方案对比" class="headerlink" title="方案对比"></a>方案对比</h3><blockquote>
<p>接下来不讨论 <code>Mysql</code> 方案数据库设计的缺点（需要看上边）</p>
</blockquote>
<p>对购物车的操作（可分为以下五种）：<br>1）加入一个新的 <code>Sku</code><br>2）原有的 <code>Sku</code> 数量加 n 减一（当然，在数量允许范围内）<br>3）指定的 <code>Sku</code> 从购物车移除（购物车减少一种 <code>Sku</code>）<br>4）清空购物车<br>5）查看购物车</p>
<p>前四项操作与第五项操作的触发关系：<br>1）必定会触发<code>5）</code>。加入之后肯定会去看购物车然后下单，除非你加入的时候不想买（这种情况不讨论）。<br>2）前端可以做处理，向后端的请求只要返回成功，前端就保持 <code>count</code> 不变，不刷新购物车，这样就不会触发<code>5）</code>。<br>3）同<code>2）</code>。<br>4）一般不会触发<code>5）</code>。</p>
<h4 id="Mysql-方案"><a href="#Mysql-方案" class="headerlink" title="Mysql 方案"></a><code>Mysql</code> 方案</h4><p>购物车（商品项列表）加层缓存。（缓存影响因素在用户）<br>缺点：</p>
<ol>
<li>用户体验<strong>相对较差</strong></li>
<li>有<strong>一定概率</strong>会出现数据库崩溃（人为触发缓存清除）</li>
<li>支持的用户量级别<strong>取决于</strong>单体 <code>Mysql</code> 能支持的并发量（并不是指支持的用户量等于数据库支持的并发量）</li>
<li>搞 <code>Mysql</code> 集群也是<strong>强弩之末</strong>，支持的用户量级别只能增加 n 倍，n 表示集群的数目节点数</li>
</ol>
<p>解析：</p>
<p>​        执行前四项操作的任何一项，都会造成购物车数据改变，这时候购物车缓存需要被清除（换句话说，为购物车加的缓存，只对用户不改变购物车数据的时候有效），如果用户选择这时候再次刷新购物车，那么请求会直接到达数据库，响应相对缓存会慢很多，用户体验较差。如果多个用户同时处于<strong>这种状态</strong>（执行过前四项操作之一，并且都选择刷新购物车，<strong>以下的这种状态也是指这个意思</strong>），那么当同时处于<strong>这种状态</strong>的用户量达到<strong>一定程度</strong>时，会对数据库<code>造成很大的负担</code>，<code>严重时</code>数据库直接<code>挂了</code>。其实这和<strong>缓存雪崩</strong>类似，区别是雪崩是数据库存在大量过期时间相同的缓存数据，缓存过期后会自动清除；而当前这种方案的话，或许缓存已经设置为永久不过期，但是一定会出现<strong>人为造成缓存清除</strong>（执行前四项操作之一）。可能有人觉得大量用户处于<strong>这种状态</strong>的概率特别小（其实，用户量比较大的时候，这个概率就特别大了），我则是认为我们不能因为概率小就忽视它，缓存雪崩的造成原因，即数据库存在大量过期时间相同的缓存数据出现的概率也是特别小的，但是往往有时候就是这种概率小的事件，给我们带来非常头疼的问题。</p>
<h4 id="Redis-方案"><a href="#Redis-方案" class="headerlink" title="Redis 方案"></a><code>Redis</code> 方案</h4><blockquote>
<p>指本文方案</p>
</blockquote>
<p>购物车（商品项列表）需要展示的数据直接从 <code>Sku</code> 缓存拿，只要 <code>Sku</code> 不改变，<code>Sku</code> 缓存就一直都在。（缓存影响因素不在用户，而在于意外）<br>优点：</p>
<ol>
<li>用户体验<strong>非常好</strong>（数据基本都放 <code>Redis</code>）</li>
<li>和 <code>Mysql</code> 方案同一级别的用户量，数据库崩溃的概率<strong>基本为 0</strong></li>
<li>出现数据库崩溃的概率<strong>有多小</strong>（<strong>健壮性好</strong>），支持的用户量级别就<strong>有多大</strong></li>
<li><code>Mysql</code> 集群的环境下，根据用户量级别配置对应的节点数，数据库崩溃的概率<strong>基本为 0</strong></li>
</ol>
<p>​        不存在了上述 <strong><code>Mysql</code> 方案</strong>的缺点，执行前四项操作的任何一项，都不会动到缓存（<code>Sku</code> 缓存）。可能有人觉得，<code>Sku</code> 缓存也可能被清除，也有极小的概率造成数据库挂了。<code>Sku</code> 缓存大量被清除的情况一般是不存在的，通过后台管理系统对 <code>Sku</code> 修改之后一定会对该商品进行 <code>Sku</code> 列表的查询（查看是否操作成功嘛），所以 <code>Sku</code> 缓存会立即恢复；除非有人直接用 <strong><code>Redis</code> 客户端</strong> 或者 <strong>命令</strong> 手动删除了缓存，这就另当别论了。其实就算真的出现 <code>Sku</code> 缓存全被清除了，大量用户同时选择刷新购物车，也没事，这里的条件还不足以触发<strong>某轮</strong>①出现上万次数据库访问②，而且<code>Sku</code> 在被刷新一次后它就被缓存起来，最多只会造成部分用户体验差点（到数据库查询 <code>Sku</code> 的那部分用户），没什么别的影响，<strong>健壮性</strong>在这里体现出来了。</p>
<blockquote>
<p>①：<strong>某轮</strong>。看下图，比如购物车 1 的第  1 个 <code>Sku</code>，购物车 2 的第 3 个 <code>Sku</code>，购物车 3 的第 2 个 <code>Sku</code>，购物车 a 的第 b 个等等好多 <code>Sku</code> 构成一轮查询同时查询数据库。</p>
<p>②：触发条件很<strong>苛刻</strong>。大量查询购物车的请求同时来到查询方法，方法中会执行一条 <code>Redis</code> 命令，其时间复杂度为 <code>O(1)</code>，又因为<code>Redis</code> 是单线程，所以这条 <code>Redis</code> 命令在这里起到了队列的作用。具体参考方法 <code>com.fatal.service.impl.ShopCartServiceImpl#shopCartGrouping</code>。所以这里除非 <code>Redis</code> 集群节点数<strong>很多</strong>而且用户量也是一个非常大的数字，不然不可能有上万并发到数据库。</p>
</blockquote>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1591416070225.png" alt="1591416070225"></p>
<p>​        如果同时存在：有人把 <code>Sku</code> 缓存全部删了；大量用户同时选择刷新购物车（1）；这些用户购物车的<strong>某轮</strong>①数据库查询达到上万次（2），并且前 n 轮都不存在相同的 <code>Sku</code>；其他用户刷新购物车（购物车含有该轮查询的 <code>Sku</code>）发生在（1）之后；其他用户执行前两项操作（购物车含有该轮查询的 <code>Sku</code>）发生在（1）之后（前两项操作做了校验，判断 <code>Sku</code> 是否存在）；其他用户在逛商城时浏览商品（含有该轮查询的 <code>Sku</code>）发生在（1）之后（商品展示的规格数据会根据是否有库存判断该 <code>Sku</code> 是否可以点击）；… 。数据库还真的有可能挂了。</p>
<p>抱歉，打搅了。</p>
<p>​        真的会出现这种情况的话，只能从硬件上解决问题，因为软件已经达到极限了。<strong>某轮</strong>①数据库查询达到上万次，而且前 n 轮都不存在相同的 <code>Sku</code>，当这个概率很大的时候，那说明这个商城的规模已经特别特别大了，它肯定很有钱，<code>Mysql</code> 搞个<strong>集群</strong>什么的肯定没什么压力，可以通过这种方式来解决问题。<code>Mysql</code> 方案也可以搞集群，但是它和 <code>Redis</code> 方案两者<strong>支持的用户量</strong>完全不在一个数量级上。（两种方案数据库崩溃的概率对比，<code>Mysql</code> 方案得配多少个 <code>Mysql</code> 集群节点才能将支持的用户量提到 <code>Redis</code> 方案一个级别啊，而且就算支持的用户量上来了，那用户体验还是没改变。）</p>
<h2 id="多规格的商品-Sku"><a href="#多规格的商品-Sku" class="headerlink" title="多规格的商品 Sku"></a>多规格的商品 Sku</h2><p><a href="https://wenku.baidu.com/view/9e8de10e6c85ec3a87c2c5c5.html" target="_blank" rel="noopener">SKU 百度文库</a></p>
<p> <code>SKU</code> = Stock Keeping Unit(库存量单位)，<code>sku</code> 可以理解为具有具体规格的商品。</p>
<p>同一种商品存在不同的规格参数值，包含这些值的属性又称为 <code>sku</code> 属性，因为它决定了 <code>SKU</code> 的绝对数量。</p>
<p> 比如40码白色帆布鞋，<strong>40</strong>与<strong>白色</strong>都属于帆布鞋的规格参数值。</p>
<p>而 38,39,40 这些值都属于<strong>码数</strong>，白色，黑色，蓝色属于<strong>颜色</strong>，这里的码数和颜色就属于帆布鞋的<code>sku</code>属性。38,39,40 与 白色，黑色，蓝色都是 <code>sku</code> 的属性选项（展示的时候叫规格参数）。</p>
<p>当商品比较简单的时候，后面笔记中的 <code>sku</code> 也可以用<code>goods</code>代替。</p>
<h2 id="为什么选择-hash-来实现？"><a href="#为什么选择-hash-来实现？" class="headerlink" title="为什么选择 hash 来实现？"></a>为什么选择 hash 来实现？</h2><p>如果使用 <code>Redis</code> 做购物车，有多少种数据类型可以选呢？</p>
<blockquote>
<p>下面一个 <code>购物车skuDTO</code> 对应一个对象 <code>{}</code></p>
</blockquote>
<p>第一：如果选择 <strong>string</strong> 呢？</p>
<ul>
<li><p><code>key：userId；value：[{skuId: xxx, count: xxx, intoTime: xxx},...]</code></p>
<p>选择 string 的话，每个用户的购物车对应一个 string 对象，value 存的是 <code>购物车skuDTO</code> <strong>集合</strong>。string 底层编码有 <code>int</code>，<code>raw</code>，<code>embstr</code>，由于我们 value 存的是字符串值的长度一般都大于 32 字节，所以 string  会选择使用<code>raw</code>编码。</p>
</li>
</ul>
<p>第二：如果选择 <strong>set</strong> 呢？</p>
<ul>
<li><p><code>key：userId；value：{skuId: xxx, count: xxx, intoTime: xxx}</code></p>
<p>选择 set 的话，每个用户的购物车对应一个 set 对象， value 存的是 <strong>单个</strong><code>购物车skuDTO</code> 。set 底层编码有 <code>intset</code> ，<code>hashtable</code></p>
<p>当集合对象同时满足以下两个条件时，对象使用 <code>intset</code> 编码；不能满足则使用 <code>hashtable</code> 编码。</p>
<ul>
<li>集合对象保存的所有元素<strong>都</strong>是整数值；</li>
<li>集合对象保存的元素数量不超过 <strong>512</strong> 个。</li>
</ul>
<p>由于 value 存的不是整数值不满足第一个条件，所以 set 使用 <code>hashtable</code> 编码。</p>
</li>
</ul>
<p>第三：如果选择 <strong>zset</strong> 呢？</p>
<ul>
<li><p><code>key：userId；value：{skuId: xxx, count: xxx}</code></p>
<p>选择 <code>zset</code> 的话，每个用户的购物车对应一个 <code>zset</code> 对象， value 存的是<code>购物车skuDTO</code>，score 存的是加入购物车的时间，让 <code>zset</code> 帮我们排序。<code>zset</code> 的底层编码是 <code>ziplist</code> 和 <code>skiplist</code>。</p>
<p>当有序集合同时满足以下两个条件时，对象使用 <code>ziplist</code> 编码；不能满足则使用 <code>skiplist</code> 编码。</p>
<ul>
<li>有序集合保存的元素数量小于 <strong>128</strong> 个；</li>
<li>有序集合保存的所有元素成员的长度<strong>都</strong>小于 <strong>64</strong> 位。</li>
</ul>
<p>由于我们将 <code>zset</code>  的元素个数限制在<strong>120</strong>之内（这是淘宝购物车单种商品的<strong>上限</strong>数量，参考<a href="https://consumerservice.taobao.com/self-help?spm=a21pu.8253647.0.0.452c480d8ShTZh#page=issue-detail&amp;knowledgeId=1116244" target="_blank" rel="noopener">购买指南</a>），满足第一条件，不过元素值长度会超过 <strong>64</strong>字节，所以<code>zset</code> 使用 <code>skiplist</code> 编码。</p>
</li>
</ul>
<p>第四：如果选择 <strong>list</strong> 呢？</p>
<ul>
<li><p><code>key： userId；value：{skuId: xxx, count: xxx}</code></p>
<p>选择 list 的话，每个用户的购物车对应一个 list 对象，value 存的是 <code>购物车skuDTO</code>。list 的底层编码是 <code>ziplist</code> 和 <code>linkedlist</code>。</p>
<p>当列表对象同时满足以下两个条件时，对象就会使用 <code>ziplist</code> 编码；不满足则使用 <code>linkedlist</code> 编码。</p>
<ul>
<li>列表对象保存的所有字符串元素的长度<strong>都</strong>小于 <strong>64</strong> 字节；</li>
<li>列表对象保存的元素数量小于 <strong>512</strong> 个。</li>
</ul>
<p>从 3.2 版本开始，<code>Redis</code> 对列表对象的底层编码做了改造，使用 <code>quicklist</code> 替代之前两种，它是 <code>ziplist</code> 和 <code>linkedlist</code> 的混合体，它会安装插入顺序排序。</p>
</li>
</ul>
<p>第五：如果选择 <strong>hash</strong> 呢？</p>
<ul>
<li><p><code>key：userId；field：skuId；value：count</code></p>
<p>选择 hash 的话，每个用户的购物车对应一个 hash 对象，field 存的是<code>skuID</code>，value 存的是购物车<code>单种sku总量</code>。hash 的底层编码是 <code>ziplist</code> 和 <code>hashtable</code>。</p>
<p>当哈希对象同时满足以下两种条件时，对象使用 <code>ziplist</code> 编码；不能满足则使用 <code>hashtable</code> 编码。</p>
<ul>
<li>哈希对象保存的所有键值对的键和值的字符串长度都小于 <strong>64</strong> 字节；</li>
<li>哈希对象保存的键值对数量小于 <strong>512</strong> 个。</li>
</ul>
<p>首先，<strong>field</strong> 的长度肯定不会超过 <strong>64</strong> 字节，<strong>value</strong> 存放的是购物车<code>单种sku总量</code>，这个数量我们系统会默认给一个上限（如：<strong>10000</strong>），第一个条件可以满足；其次，<code>购物车 sku 的种类</code>我们可以限制在 120 之内（这个数字你随意，在 <strong>512</strong> 之内即可），第二个条件也可以满足。两个条件都能同时满足，使用 hash 做购物车的时候，hash 对象（的 field）使用 <code>ziplist</code> 编码，<strong>它会按照插入顺序排序</strong>。这也是我们没有存 <code>加入购物车时间</code>的原因，它已经帮我们保留了顺序，所以这个时间就<strong>多余</strong>了。</p>
</li>
</ul>
<p>相比这五种选择，除了hash，其它的数据类型，都需要 <strong>get 出来计算后 set 回去</strong>，有的还需保存<code>加入购物车时间</code> 来排序。用来做购物车还是可以的，就是有点小麻烦，也没有充分利用 <code>Redis</code> 的数据类型（充分利用的话性能有很大的优势）；而 hash 就不一样了，我们满足它以 <code>ziplist</code>编码的条件，它就是<strong><code>有序</code></strong>的了 ，不需要额外计算，可以直接使用 <code>Redis</code> 命令来完成对购物车的维护，性能上无疑达到了<strong>最优</strong>，这简直就是 <code>Redis</code>为购物车专门定制的一套 <code>完美的方案</code> 嘛。:heart_eyes:</p>
<h2 id="相关命令时间复杂度"><a href="#相关命令时间复杂度" class="headerlink" title="相关命令时间复杂度"></a>相关命令时间复杂度</h2><table>
<thead>
<tr>
<th style="text-align:left">Spring Data Redis</th>
<th>Redis 命令</th>
<th style="text-align:center">Redis 命令时间复杂度</th>
<th style="text-align:center">最终时间复杂度</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">HV get(K key, Object hashKey)</td>
<td><code>hget</code> key field</td>
<td style="text-align:center"><code>O(1)</code></td>
<td style="text-align:center"><code>O(1)</code></td>
</tr>
<tr>
<td style="text-align:left">void put(K key, HK hashKey, HV value)</td>
<td><code>hset</code> key field value</td>
<td style="text-align:center"><code>O(1)</code></td>
<td style="text-align:center"><code>O(1)</code></td>
</tr>
<tr>
<td style="text-align:left">Long size(K key)</td>
<td><code>hlen</code> key</td>
<td style="text-align:center"><code>O(1)</code></td>
<td style="text-align:center"><code>O(1)</code></td>
</tr>
<tr>
<td style="text-align:left">Long increment(K key, HK hashKey, long delta)</td>
<td><code>hincrby</code> key field increment</td>
<td style="text-align:center"><code>O(1)</code></td>
<td style="text-align:center"><code>O(1)</code></td>
</tr>
<tr>
<td style="text-align:left">Map&lt;HK, HV&gt; entries(K key)</td>
<td><code>hgetall</code> key</td>
<td style="text-align:center"><code>O(N)</code> N是hash元素个数</td>
<td style="text-align:center">购物车<code>Sku</code>种类限制最多120，所以最坏的情况下是O(120)。<code>O(1~120)</code></td>
</tr>
<tr>
<td style="text-align:left">Cursor&lt;Entry&lt;HK, HV&gt;&gt; scan(K key, ScanOptions options)</td>
<td><code>hscan</code> key cursor <code>[MATCH pattern][COUNT count]</code></td>
<td style="text-align:center"><code>O(1)</code></td>
<td style="text-align:center"><code>O(1)</code></td>
</tr>
<tr>
<td style="text-align:left">Long delete(K key, Object… hashKeys)</td>
<td><code>hdel</code> key [key …]</td>
<td style="text-align:center"><code>O(N)</code> N是被删除的field的数量</td>
<td style="text-align:center">购物车<code>Sku</code>种类限制最多120，所以最坏的情况下是O(120)。<code>O(1~120)</code></td>
</tr>
<tr>
<td style="text-align:left">Boolean delete(K key)</td>
<td><code>del</code> key [key …]</td>
<td style="text-align:center"><code>O(N)</code> N是被删除的key的数量，key 可以是任何类型；比如<strong>hash</strong>，删除一个key的时间复杂度也是<strong>O(1)</strong>。</td>
<td style="text-align:center">清空购物车，删除一个hash，所以时间复杂度是<code>O(1)</code></td>
</tr>
</tbody>
</table>
<blockquote>
<ul>
<li>用 <code>hscan</code> 取代 <code>hgetall</code> 优化性能</li>
<li><code>hdel</code> 删除 <code>field</code> 的个数一般不会很大。</li>
</ul>
</blockquote>
<h2 id="Redis-底层编码-ziplist"><a href="#Redis-底层编码-ziplist" class="headerlink" title="Redis 底层编码 ziplist"></a>Redis 底层编码 ziplist</h2><p><code>ziplist</code> 重点：</p>
<ul>
<li>压缩列表是一种为节约内存而开发的的<strong><code>顺序</code></strong>型数据结构。（这是<strong>重点</strong>）</li>
<li>压缩列表被用作<code>列表键</code>和 <strong><code>哈希键</code></strong> 的底层实现之一。</li>
<li>压缩列表可以包含多个节点，每个节点可以保存一个字节数组或者整数值。</li>
<li>添加新节点到压缩列表，或者从压缩列表中删除节点，可能会引发<strong>连锁更新</strong>操作，但这种操作出现的<strong>几率不高</strong>。</li>
</ul>
<p>​        因为<strong>连锁更新</strong>在最坏的情况下需要对压缩列表进行 <strong>N</strong> 次空间重分配操作，而每次空间重分配操作的最坏复杂度为 <strong>O(N)</strong>，所以连锁更新的最坏复杂度为 <strong>O(N²)</strong> </p>
<ul>
<li>首先，压缩列表里要恰好有多个连续的、长度介于 <strong>250</strong> 字节至 <strong>253</strong> 字节的节点，<strong>连锁更新</strong>才有可能被引发，<strong>在实际中，这种情况并不多见</strong>；</li>
<li>其次，即使出现<strong>连锁更新</strong>，但只要被更新的节点数量<strong>不多</strong>，就<strong>不会</strong>对性能造成<strong>任何</strong>的<strong>影响</strong>：比如说，对三五个节点进行连锁更新是绝对不会影响性能的。</li>
</ul>
<p>​        <code>Redis</code> 的 hash 选择<code>ziplist</code>编码的第一个条件要求：所有的 <code>field</code> 和 <code>value</code> 值的长度都小于<strong>64</strong>字节，<strong>64</strong> 远小于 <strong>250</strong>，所以我们可以不用担心 <code>Redis</code> 的 hash 会出现<strong>连锁更新</strong>。</p>
<h2 id="hash-实现购物车"><a href="#hash-实现购物车" class="headerlink" title="hash 实现购物车"></a>hash 实现购物车</h2><p>​       使用 <code>Redis</code> 的 <strong>hash</strong> 数据类型实现购物车，每个用户的购物车则对应一张哈希表。哈希表每个元素的 <strong>field</strong> 存储<code>skuID</code>，<strong>value</strong> 存储订购<code>sku</code>的数量。购物车中<strong>单个<code>sku</code>订购的数量</strong>需要有上限，系统默认对加入购物车的<code>sku</code> <code>统一</code>设置了上限（例如：<code>10000</code>），卖家可以在这个上限的范围之内再设置一个小于系统默认值的上限（例如：<code>200</code>）；<strong>购物车的<code>sku</code>的种类</strong>也需要有上限，系统默认对购物车的商品种类设置了上限，例如：<code>120</code>，这个数字是淘宝的默认值，当用户的购物车有<code>120</code>种<code>sku</code>的时候，它不能再添加新的<code>sku</code>进购物车。</p>
<p><code>Redis</code> 做购物车，这里选择了 <strong>hash</strong> 类型，每个用户的购物车对应一个 <strong>hash</strong> 对象。如下：</p>
<table>
<thead>
<tr>
<th>key</th>
<th>field</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>userId</td>
<td><code>skuId</code></td>
<td>count</td>
</tr>
<tr>
<td>用户ID</td>
<td><code>skuID</code></td>
<td>单种<code>sku</code>总量</td>
</tr>
</tbody>
</table>
<p>这是这次选择的方案，直接用 <code>Redis</code> 命令<code>保存</code>，<code>移除（部分）</code>，<code>清空</code>，<code>查询购物车</code>，前三个不需要额外的计算。</p>
<p>由于购物车需要保留<strong>两种顺序</strong>，一种是添加的顺序，另一种是计算后展示的顺序（同一个店铺的商品，只要有一个是刚添加的，那么就算其他的是最早添加，这个店铺也是排在购物车的第一位），所以这里还需要设计一张哈希表。（记录 <code>shopId</code> 是为了后边分组）</p>
<table>
<thead>
<tr>
<th>key</th>
<th>field</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>userId</td>
<td><code>skuId</code></td>
<td>shopId</td>
</tr>
<tr>
<td>用户ID</td>
<td><code>skuID</code></td>
<td>店铺ID</td>
</tr>
</tbody>
</table>
<p>这个哈希表不是必要的。你也可以去掉，但是去掉之后，每次查询购物车要拿到<strong>和店铺的关系数据</strong>（就是这张哈希表）都得通过遍历拿出所有 <code>Sku</code> 数据，虽然每次拿使用的 <code>get</code> 命令的时间复杂度是 <code>O(1)</code>，但是购物车<code>Sku</code>种类限制最多有120，所以最坏的情况下也是 <code>O(120)</code>，和使用 <code>hgetall</code> 效果差不多；加了这个哈希表就不一样了，通过简单的维护，后边需要拿<strong>和店铺的关系数据</strong>的时候，直接使用时间复杂度为 <code>O(1)</code> 的 <code>hscan</code> 命令即可，所以建议加上它。</p>
<h2 id="环境-版本一览："><a href="#环境-版本一览：" class="headerlink" title="环境/版本一览："></a>环境/版本一览：</h2><ul>
<li>开发工具：Intellij IDEA 2019.1.3</li>
<li>springboot： <strong>2.1.7.RELEASE</strong></li>
<li>jdk：1.8.0_171</li>
<li>maven：3.3.9</li>
<li>mysql-connector-java：5.1.47</li>
</ul>
<h2 id="1、pom-xml"><a href="#1、pom-xml" class="headerlink" title="1、pom.xml"></a>1、pom.xml</h2><div class="highlight-wrap-higher"><div class="highlight-wrap"><figure class="iseeu highlight /xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 整合Lettuce Redis需要commons-pool2 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 版本用 5.x 的，与本地保持一致 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.code.gson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div>
<h2 id="2、application-yml"><a href="#2、application-yml" class="headerlink" title="2、application.yml"></a>2、application.yml</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  datasource:</span></span><br><span class="line"><span class="attr">    driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="comment"># 基本属性</span></span><br><span class="line"><span class="attr">    url:</span> <span class="attr">jdbc:mysql://localhost:3306/chapter29?useUnicode=true&amp;characterEncoding=UTF-8&amp;allowMultiQueries=true&amp;serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    password:</span> <span class="number">123456</span></span><br><span class="line"><span class="attr">  jpa:</span></span><br><span class="line">    <span class="comment"># 显示 sql</span></span><br><span class="line"><span class="attr">    show-sql:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 数据库类型</span></span><br><span class="line"><span class="attr">    database:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="comment"># JPA 配置</span></span><br><span class="line"><span class="attr">    hibernate:</span></span><br><span class="line"><span class="attr">      ddl-auto:</span> <span class="string">update</span></span><br><span class="line">    <span class="comment"># 指定生成的表的引擎为InnoDB类型（默认是MyISAM，MyISAM不支持事务）</span></span><br><span class="line"><span class="attr">    database-platform:</span> <span class="string">org.hibernate.dialect.MySQL57InnoDBDialect</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  redis:</span></span><br><span class="line"><span class="attr">    host:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">    password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="comment"># Redis默认情况下有16个分片，这里配置具体使用的分片，默认是0</span></span><br><span class="line"><span class="attr">    database:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">    lettuce:</span></span><br><span class="line"><span class="attr">      pool:</span></span><br><span class="line">        <span class="comment"># 当池耗尽时，在引发异常之前连接分配可以阻塞的最长时间（使用负值表示没有限制） 默认 -1</span></span><br><span class="line"><span class="attr">        max-wait:</span> <span class="bullet">-1</span><span class="string">ms</span></span><br><span class="line">        <span class="comment"># 连接池最大连接数（使用负值表示没有限制） 默认 8</span></span><br><span class="line"><span class="attr">        max-active:</span> <span class="number">8</span></span><br><span class="line">        <span class="comment"># 连接池中的最大空闲连接 默认 8</span></span><br><span class="line"><span class="attr">        max-idle:</span> <span class="number">8</span></span><br><span class="line">        <span class="comment"># 连接池中的最小空闲连接 默认 0</span></span><br><span class="line"><span class="attr">        min-idle:</span> <span class="number">0</span></span><br><span class="line">    <span class="comment"># 连接超时时间</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">10000</span><span class="string">ms</span></span><br><span class="line">    <span class="comment"># 一般来说是不用配置的，Spring Cache 会根据依赖的包自行装配</span></span><br><span class="line"><span class="attr">  cache:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">redis</span></span><br></pre></td></tr></table></figure>
<h2 id="3、sql"><a href="#3、sql" class="headerlink" title="3、sql"></a>3、sql</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">SQLyog Ultimate v12.09 (64 bit)</span><br><span class="line">MySQL - 5.7.22 : Database - chapter29</span><br><span class="line">*********************************************************************</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/*!40101 SET NAMES utf8 */;</span><br><span class="line"></span><br><span class="line">/*!40101 SET SQL_MODE=&apos;&apos;*/;</span><br><span class="line"></span><br><span class="line">/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;</span><br><span class="line">/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;</span><br><span class="line">/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=&apos;NO_AUTO_VALUE_ON_ZERO&apos; */;</span><br><span class="line">/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;</span><br><span class="line">CREATE DATABASE /*!32312 IF NOT EXISTS*/`chapter29` /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_bin */;</span><br><span class="line"></span><br><span class="line">USE `chapter29`;</span><br><span class="line"></span><br><span class="line">/*Table structure for table `sku` */</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `sku`;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `sku` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &apos;skuId&apos;,</span><br><span class="line">  `goods_id` bigint(20) NOT NULL COMMENT &apos;商品ID&apos;,</span><br><span class="line">  `goods_name` varchar(32) COLLATE utf8mb4_bin NOT NULL COMMENT &apos;商品名称&apos;,</span><br><span class="line">  `max` int(11) NOT NULL COMMENT &apos;购物车单种sku允许最大个数&apos;,</span><br><span class="line">  `picture` varchar(255) COLLATE utf8mb4_bin NOT NULL COMMENT &apos;sku图片&apos;,</span><br><span class="line">  `price` bigint(20) NOT NULL COMMENT &apos;sku单价&apos;,</span><br><span class="line">  `properties` varchar(255) COLLATE utf8mb4_bin NOT NULL DEFAULT &apos;&apos; COMMENT &apos;sku规格&apos;,</span><br><span class="line">  `shop_id` bigint(20) NOT NULL COMMENT &apos;店铺ID&apos;,</span><br><span class="line">  `shop_name` varchar(32) COLLATE utf8mb4_bin NOT NULL COMMENT &apos;店铺名&apos;,</span><br><span class="line">  `status` int(11) NOT NULL COMMENT &apos;sku状态：-1 下架; 0 删除; 1 在架&apos;,</span><br><span class="line">  `stock` int(11) NOT NULL COMMENT &apos;sku库存&apos;,</span><br><span class="line">  `create_time` datetime NOT NULL,</span><br><span class="line">  `update_time` datetime NOT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=14 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;</span><br><span class="line"></span><br><span class="line">/*Data for the table `sku` */</span><br><span class="line"></span><br><span class="line">insert  into `sku`(`id`,`goods_id`,`goods_name`,`max`,`picture`,`price`,`properties`,`shop_id`,`shop_name`,`status`,`stock`,`create_time`,`update_time`) values (1,111111,&apos;帆布鞋&apos;,300,&apos;http://...pic...123.png&apos;,55000,&apos;白色;40&apos;,123457,&apos;MiCai Shop&apos;,1,1000,&apos;2019-08-20 14:02:38&apos;,&apos;2019-08-20 14:02:38&apos;),(2,222222,&apos;太阳帽&apos;,300,&apos;http://...pic...123.png&apos;,21000,&apos;黑色&apos;,123457,&apos;MiCai Shop&apos;,1,1000,&apos;2019-08-20 14:07:26&apos;,&apos;2019-08-20 14:07:26&apos;),(3,222222,&apos;太阳帽&apos;,200,&apos;http://...pic...123.png&apos;,21000,&apos;蓝色&apos;,123457,&apos;MiCai Shop&apos;,1,1000,&apos;2019-08-20 14:08:03&apos;,&apos;2019-08-20 14:08:03&apos;),(4,444444,&apos;男士皮鞋&apos;,500,&apos;http://...pic...123.png&apos;,221000,&apos;40;黑色编织镂空款B1923913&apos;,123456,&apos;Fatal Shop&apos;,1,1000,&apos;2019-08-20 14:20:07&apos;,&apos;2019-08-20 14:20:07&apos;),(5,444444,&apos;男士皮鞋&apos;,500,&apos;http://...pic...123.png&apos;,221000,&apos;39;黑色编织镂空款B1923913&apos;,123456,&apos;Fatal Shop&apos;,0,1000,&apos;2019-08-20 14:21:01&apos;,&apos;2019-08-20 14:21:01&apos;),(6,444444,&apos;男士皮鞋&apos;,500,&apos;http://...pic...123.png&apos;,221000,&apos;43;黑色编织镂空款B1923913&apos;,123456,&apos;Fatal Shop&apos;,1,1000,&apos;2019-08-20 14:21:56&apos;,&apos;2019-08-20 14:21:56&apos;),(7,333333,&apos;限量款骑士领带&apos;,2,&apos;http://...pic...123.png&apos;,521000,&apos;棕色&apos;,123456,&apos;Fatal Shop&apos;,1,1000,&apos;2019-08-20 14:23:36&apos;,&apos;2019-08-20 14:23:36&apos;),(8,431235,&apos;女生西装&apos;,100,&apos;http://...pic...123.png&apos;,1121000,&apos;L;灰色&apos;,123458,&apos;MiQI Shop&apos;,1,1000,&apos;2019-08-21 16:46:19&apos;,&apos;2019-08-21 16:46:19&apos;),(9,431312,&apos;男士西装&apos;,100,&apos;http://...pic...123.png&apos;,911000,&apos;XL;灰色&apos;,123458,&apos;MiQI Shop&apos;,1,1000,&apos;2019-08-21 16:47:50&apos;,&apos;2019-08-21 16:47:50&apos;),(10,221312,&apos;男士中邦皮靴&apos;,200,&apos;http://...pic...123.png&apos;,111000,&apos;40;豹纹&apos;,123458,&apos;MiQI Shop&apos;,1,1000,&apos;2019-08-21 16:49:34&apos;,&apos;2019-08-21 16:49:34&apos;),(11,151312,&apos;胸针&apos;,10,&apos;http://...pic...123.png&apos;,211000,&apos;骑士银&apos;,123458,&apos;MiQI Shop&apos;,1,1000,&apos;2019-08-21 16:51:15&apos;,&apos;2019-08-21 16:51:15&apos;),(12,151312,&apos;胸针&apos;,10,&apos;http://...pic...123.png&apos;,191000,&apos;骑士蓝&apos;,123457,&apos;MiCai Shop&apos;,1,1000,&apos;2019-08-21 16:53:05&apos;,&apos;2019-08-21 16:53:05&apos;),(13,151312,&apos;胸针&apos;,10,&apos;http://...pic...123.png&apos;,191000,&apos;骑士红&apos;,123457,&apos;MiCai Shop&apos;,-1,1000,&apos;2019-08-23 16:13:27&apos;,&apos;2019-08-23 16:13:27&apos;);</span><br><span class="line"></span><br><span class="line">/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;</span><br><span class="line">/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;</span><br><span class="line">/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;</span><br><span class="line">/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;</span><br></pre></td></tr></table></figure>
<h2 id="4、config"><a href="#4、config" class="headerlink" title="4、config"></a>4、config</h2><p>配置两部分：（ <code>Json</code> 序列化）</p>
<ul>
<li>自定义 <code>RedisCacheConfiguration</code> 的序列化方式</li>
<li>自定义 <code>RedisTemplate</code>，以及 <code>key</code>，<code>value</code>，<code>hashKey</code>，<code>hashValue</code> 的序列化方式。<code>hashKey</code>，<code>hashValue</code> 存储的是 <strong>Long</strong> 类型或者 <strong>Integer</strong> 类型，所以序列化方式可以选择 <code>GenericJackson2JsonRedisSerializer</code>。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.cache.RedisCacheConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.RedisSerializationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.RedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Redis 配置组件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/14 0014 19:26</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义 RedisCacheConfiguration</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisCacheConfiguration <span class="title">redisCacheConfiguration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RedisCacheConfiguration.defaultCacheConfig()</span><br><span class="line">                <span class="comment">// 自定义 key 的序列化器</span></span><br><span class="line">                .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(keySerializer()))</span><br><span class="line">                <span class="comment">// 自定义 value 的序列化器</span></span><br><span class="line">                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(genericJackson2JsonRedisSerializer()))</span><br><span class="line">                <span class="comment">// 禁止缓存 null 值</span></span><br><span class="line">                .disableCachingNullValues();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义 RedisTemplate</span></span><br><span class="line"><span class="comment">     * Key: StringRedisSerializer</span></span><br><span class="line"><span class="comment">     * Value: genericJackson2JsonRedisSerializer</span></span><br><span class="line"><span class="comment">     * HashKey: genericJackson2JsonRedisSerializer</span></span><br><span class="line"><span class="comment">     * HashValue: genericJackson2JsonRedisSerializer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, Serializable&gt; <span class="title">serializableRedisTemplate</span><span class="params">(LettuceConnectionFactory connectionFactory)</span> </span>&#123;</span><br><span class="line">        RedisTemplate&lt;String, Serializable&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        redisTemplate.setKeySerializer(keySerializer());</span><br><span class="line">        redisTemplate.setValueSerializer(genericJackson2JsonRedisSerializer());</span><br><span class="line">        redisTemplate.setHashKeySerializer(genericJackson2JsonRedisSerializer());</span><br><span class="line">        redisTemplate.setHashValueSerializer(genericJackson2JsonRedisSerializer());</span><br><span class="line">        redisTemplate.setConnectionFactory(connectionFactory);</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisSerializer&lt;String&gt; <span class="title">keySerializer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StringRedisSerializer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GenericJackson2JsonRedisSerializer <span class="title">genericJackson2JsonRedisSerializer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> GenericJackson2JsonRedisSerializer();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5、common"><a href="#5、common" class="headerlink" title="5、common"></a>5、common</h2><h3 id="5-1、constants"><a href="#5-1、constants" class="headerlink" title="5.1、constants"></a>5.1、constants</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.common.constants;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 购物车常量</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/15 0015 8:16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ShopCartConstant</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 购物车key前缀</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String SHOP_CART = <span class="string">"SHOP_CART:%s"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用于分组的购物车（后续需要按店铺分组）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String SHOP_CART_FOR_GROUPING = <span class="string">"SHOP_CART_FOR_GROUPING:%s"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 排序购物车</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String SORT_SHOP_CART = <span class="string">"SORT_SHOP_CART"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 购物车分页（根据排序购物车计算出的分页）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String SHOP_CART_PAGE = <span class="string">"SHOP_CART_PAGE"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 系统统一数据：单种sku允许添加到购物车的数额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Integer MAX = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 系统统一数据：允许添加到购物车sku种类的数额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Integer TYPE_MAX = <span class="number">120</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 购物车每页显示条数（以淘宝为例，每次下拉都会刷新 31 条记录）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">//    Integer PAGE_SIZE = 16;</span></span><br><span class="line">    Integer PAGE_SIZE = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 为购物车加上前缀</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">getCartKey</span><span class="params">(Long userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(ShopCartConstant.SHOP_CART, userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">getGroupingKey</span><span class="params">(Long userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(ShopCartConstant.SHOP_CART_FOR_GROUPING, userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-2、enums"><a href="#5-2、enums" class="headerlink" title="5.2、enums"></a>5.2、enums</h3><h4 id="ResponseEnum-java"><a href="#ResponseEnum-java" class="headerlink" title="ResponseEnum.java"></a><code>ResponseEnum.java</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.common.enums;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/18 0018 11:10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ResponseEnum &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 购物车已满，不能添加新sku</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SHOP_CART_SKU_TYPE_COUNT_FULL(<span class="number">10000</span>, <span class="string">"购物车已满，不能添加新sku"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据库不存在此sku</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SKU_IS_NOT_EXISTS(<span class="number">10100</span>, <span class="string">"数据库不存在此sku"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * sku已下架</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SKU_IS_OFF_THE_SHELVES(<span class="number">10101</span>, <span class="string">"sku已下架"</span>),</span><br><span class="line"></span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    ResponseEnum(Integer code, String message) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="StatusEnums-java"><a href="#StatusEnums-java" class="headerlink" title="StatusEnums.java"></a><code>StatusEnums.java</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.common.enums;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 状态枚举</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/15 0015 17:49</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> StatusEnums &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    NORMAL(<span class="number">1</span>, <span class="string">"NORMAL"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 已删除</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    DELETED(<span class="number">0</span>, <span class="string">"DELETED"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下架</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    PROHIBIT(-<span class="number">1</span>, <span class="string">"PROHIBIT"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    StatusEnums(Integer code, String message) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-3、exception"><a href="#5-3、exception" class="headerlink" title="5.3、exception"></a>5.3、exception</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.common.exception;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fatal.common.enums.ResponseEnum;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.ConstraintViolationException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义校验异常，可以被本类异常处理器catch；优先本类的处理器，如果没有本类的，往上一层。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/18 0018 11:00</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateException</span> <span class="keyword">extends</span> <span class="title">ConstraintViolationException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ValidateException</span><span class="params">(ResponseEnum responseEnum)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(responseEnum.getMessage(), <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-4、handler"><a href="#5-4、handler" class="headerlink" title="5.4、handler"></a>5.4、handler</h3><p>自定义全局异常处理器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.common.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.ConstraintViolationException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/16 0016 14:11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 校验异常处理器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(value = ConstraintViolationException.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">constraintViolationException</span><span class="params">(ConstraintViolationException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.badRequest().body(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-5、utils"><a href="#5-5、utils" class="headerlink" title="5.5、utils"></a>5.5、utils</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.common.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.gson.Gson;</span><br><span class="line"><span class="keyword">import</span> com.google.gson.GsonBuilder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/9 0009 22:47</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Gson gson;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        GsonBuilder gsonBuilder = <span class="keyword">new</span> GsonBuilder();</span><br><span class="line">        gsonBuilder.setPrettyPrinting();</span><br><span class="line">        gson = gsonBuilder.create();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">JsonUtil</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 控制台输出Json格式的对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">toJson</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> gson.toJson(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">fromJson</span><span class="params">(String json, Class&lt;T&gt; classOfT)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> gson.fromJson(json, classOfT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6、entity"><a href="#6、entity" class="headerlink" title="6、entity"></a>6、entity</h2><p>记得实现 <code>Serializable</code>，后面自定义的<code>RedisTemplate</code>保存的 <strong>value</strong> 只要实现 <code>Serializable</code> 接口即可。（Spring Cache 缓存的对象不需要实现 <code>Serializable</code> 接口）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.annotation.JsonDeserialize;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.annotation.JsonSerialize;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.deser.LocalDateTimeDeserializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.ser.LocalDateTimeSerializer;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.experimental.Accessors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.io.`Serializable;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全名 Stock Keeping Unit(库存量最小单位)，可以理解为有具体规格的商品。例如：40码白色帆布鞋。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/14 0014 17:15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Accessors</span>(chain = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sku</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * skuID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)     <span class="comment">// 这里为了方便，用自增</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long goodsId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 店铺ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long shopId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 店铺名称（冗余字段）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String shopName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品名称（冗余字段）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String goodsName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * sku单价（单位：分）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long price;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * sku库存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer stock;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * sku图片</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String picture;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 规格（规格本来应该是张表的，这里为了方便，就直接 String）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String properties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单种sku允许添加到购物车的最大数额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer max;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonDeserialize</span>(using = LocalDateTimeDeserializer.class)</span><br><span class="line">    <span class="meta">@JsonSerialize</span>(using = LocalDateTimeSerializer.class)</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonDeserialize</span>(using = LocalDateTimeDeserializer.class)</span><br><span class="line">    <span class="meta">@JsonSerialize</span>(using = LocalDateTimeSerializer.class)</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * sku状态：-1 下架; 0 删除; 1 在架</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7、dto"><a href="#7、dto" class="headerlink" title="7、dto"></a>7、dto</h2><blockquote>
<p>位于 <code>controller</code> 和 <code>service</code> 两层，不包括 <code>RedisTestDTO</code>，它只是测试用的。</p>
</blockquote>
<h3 id="RedisTestDTO-java"><a href="#RedisTestDTO-java" class="headerlink" title="RedisTestDTO.java"></a><code>RedisTestDTO.java</code></h3><p>测试数据类型的底层数据结构</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.experimental.Accessors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用于测试</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/19 0019 10:25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors</span>(chain = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisTestDTO</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long skuId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer count;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ShopCartDTO-java"><a href="#ShopCartDTO-java" class="headerlink" title="ShopCartDTO.java"></a><code>ShopCartDTO.java</code></h3><p>对应 <code>ShopCartVO</code>，属性完全一样的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.experimental.Accessors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 店铺DTO，包含了`店铺`信息和`购物车sku`信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/15 0015 19:17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors</span>(chain = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShopCartDTO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 店铺ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long shopId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 店铺名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String shopName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 购物车sku集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;ShopCartItemDTO&gt; items;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ShopCartDTO <span class="title">of</span><span class="params">(ShopCartSkuDTO shopCartSkuDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ShopCartDTO()</span><br><span class="line">                .setShopId(shopCartSkuDTO.getShopId())</span><br><span class="line">                .setShopName(shopCartSkuDTO.getShopName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ShopCartSkuDTO-java"><a href="#ShopCartSkuDTO-java" class="headerlink" title="ShopCartSkuDTO.java"></a><code>ShopCartSkuDTO.java</code></h3><p>与 <code>ShopCartItemDTO</code> 的区别就是多了 <code>shopId</code> 和<code>shopName</code>，这两个属性用于后边<strong>分组</strong>和<strong>展示</strong>；少了 <code>count</code> 属性，这个属性不在 <code>ISkuService</code> 对外 <code>DTO</code> 的范畴中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fatal.entity.Sku;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.EqualsAndHashCode;</span><br><span class="line"><span class="keyword">import</span> lombok.experimental.Accessors;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 购物车skuDTO，包含了购物车需要显示的所有数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desc</span> <span class="doctag">@EqualsAndHashCode</span> 这里只选择了两个属性，是为了后面去重；先去重后map，可以减少大部分操作。</span></span><br><span class="line"><span class="comment"> *      注：这个属于 ISkuService 对外交互的DTO，是必不可少的。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/15 0015 17:45</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors</span>(chain = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@EqualsAndHashCode</span>(of = &#123;<span class="string">"shopId"</span>, <span class="string">"shopName"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShopCartSkuDTO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * skuID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 店铺ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long shopId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 店铺名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String shopName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String goodsName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * sku单价（单位：分）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long price;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * sku图片</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String picture;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 规格（规格本来应该是张表的，这里为了方便，就直接 String）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String properties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单种sku允许添加到购物车的最大数额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer max;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * sku状态：-1 下架; 0 删除; 1 在架</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ShopCartSkuDTO <span class="title">of</span><span class="params">(Sku sku)</span> </span>&#123;</span><br><span class="line">        ShopCartSkuDTO dto = <span class="keyword">new</span> ShopCartSkuDTO();</span><br><span class="line">        BeanUtils.copyProperties(sku, dto);</span><br><span class="line">        <span class="keyword">return</span> dto;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ShopCartItemDTO-java"><a href="#ShopCartItemDTO-java" class="headerlink" title="ShopCartItemDTO.java"></a><code>ShopCartItemDTO.java</code></h3><p>对应 <code>ShopCartItemVO</code>，属性完全一样的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.experimental.Accessors;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 购物车skuDTO，去掉了重复的属性</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/15 0015 17:45</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors</span>(chain = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShopCartItemDTO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * skuID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String goodsName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * sku单价（单位：分）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long price;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * sku图片</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String picture;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 规格（规格本来应该是张表的，这里为了方便，就直接 String）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String properties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单种sku允许添加到购物车的最大数额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer max;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * sku个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer count;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * sku状态：-1 下架; 0 删除; 1 在架</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ShopCartItemDTO <span class="title">of</span><span class="params">(ShopCartSkuDTO shopCartSkuDTO)</span> </span>&#123;</span><br><span class="line">        ShopCartItemDTO shopCartItemDTO = <span class="keyword">new</span> ShopCartItemDTO();</span><br><span class="line">        BeanUtils.copyProperties(shopCartSkuDTO, shopCartItemDTO);</span><br><span class="line">        <span class="keyword">return</span> shopCartItemDTO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;ShopCartItemDTO&gt; <span class="title">of</span><span class="params">(List&lt;ShopCartSkuDTO&gt; shopCartSkuDTOs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> shopCartSkuDTOs.stream()</span><br><span class="line">                .map(ShopCartItemDTO::of)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="8、vo"><a href="#8、vo" class="headerlink" title="8、vo"></a>8、vo</h2><blockquote>
<p>位于 <code>controller</code> 层，用在视图展示，可以将一个或多个<code>DTO</code>改造成需要展示的数据放在<code>VO</code>中。</p>
</blockquote>
<h3 id="ShopCartVO-java"><a href="#ShopCartVO-java" class="headerlink" title="ShopCartVO.java"></a><code>ShopCartVO.java</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fatal.dto.ShopCartDTO;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.experimental.Accessors;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 店铺VO，包含了`店铺`信息和`购物车sku`信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/15 0015 19:17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors</span>(chain = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShopCartVO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 店铺ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long shopId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 店铺名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String shopName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 购物车sku集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;ShopCartItemVO&gt; items;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ShopCartVO <span class="title">of</span><span class="params">(ShopCartDTO shopCartDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ShopCartVO()</span><br><span class="line">                .setShopId(shopCartDTO.getShopId())</span><br><span class="line">                .setShopName(shopCartDTO.getShopName())</span><br><span class="line">                .setItems(ShopCartItemVO.of(shopCartDTO.getItems()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;ShopCartVO&gt; <span class="title">of</span><span class="params">(List&lt;ShopCartDTO&gt; shopCartDTOs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> CollectionUtils.isEmpty(shopCartDTOs) ?</span><br><span class="line">                <span class="keyword">new</span> ArrayList&lt;&gt;() :</span><br><span class="line">                shopCartDTOs.stream()</span><br><span class="line">                    .map(ShopCartVO::of)</span><br><span class="line">                    .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ShopCartItemVO-java"><a href="#ShopCartItemVO-java" class="headerlink" title="ShopCartItemVO.java"></a><code>ShopCartItemVO.java</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fatal.dto.ShopCartItemDTO;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.experimental.Accessors;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 购物车skuVO，去掉了重复的属性</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/15 0015 17:45</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors</span>(chain = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShopCartItemVO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * skuID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String goodsName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * sku单价（单位：分）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long price;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * sku图片</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String picture;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 规格（规格本来应该是张表的，这里为了方便，就直接 String）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String properties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单种sku允许添加到购物车的最大数额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@desc</span> 前端用于判断，不给用户随便输入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer max;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * sku个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer count;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * sku状态：-1 下架; 0 删除; 1 在架</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@desc</span> 前端用于判断，下架的sku不允许移出购物车（count减1），只给用户移除整个sku。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ShopCartItemVO <span class="title">of</span><span class="params">(ShopCartItemDTO shopCartItemDTO)</span> </span>&#123;</span><br><span class="line">        ShopCartItemVO shopCartItemVO = <span class="keyword">new</span> ShopCartItemVO();</span><br><span class="line">        BeanUtils.copyProperties(shopCartItemDTO, shopCartItemVO);</span><br><span class="line">        <span class="keyword">return</span> shopCartItemVO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;ShopCartItemVO&gt; <span class="title">of</span><span class="params">(List&lt;ShopCartItemDTO&gt; shopCartItemDTOs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> shopCartItemDTOs.stream()</span><br><span class="line">                .map(ShopCartItemVO::of)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="9、repository"><a href="#9、repository" class="headerlink" title="9、repository"></a>9、repository</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fatal.entity.Sku;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/14 0014 17:33</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SkuRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Sku</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查找未删除的Sku</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Sku <span class="title">findByIdAndStatusIsNot</span><span class="params">(Long id, Integer status)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="10、service"><a href="#10、service" class="headerlink" title="10、service"></a>10、service</h2><h3 id="ISkuService-java"><a href="#ISkuService-java" class="headerlink" title="ISkuService.java"></a><code>ISkuService.java</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fatal.dto.ShopCartSkuDTO;</span><br><span class="line"><span class="keyword">import</span> com.fatal.entity.Sku;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/14 0014 18:21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ISkuService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据skuID查找sku</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Sku <span class="title">getById</span><span class="params">(Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据skuID查询购物车skuDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ShopCartSkuDTO <span class="title">getShopCartSkuById</span><span class="params">(Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="IShopCartService-java"><a href="#IShopCartService-java" class="headerlink" title="IShopCartService.java"></a><code>IShopCartService.java</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fatal.dto.ShopCartDTO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 购物车服务</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/14 0014 23:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IShopCartService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 改变指定 sku 的 count</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> skuId skuID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> finalValue count 的最终值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">put</span><span class="params">(Long userId, Long skuId, Long finalValue)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 购物车列表分页</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currentPage</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;ShopCartDTO&gt; <span class="title">shopCarts</span><span class="params">(Long userId, Integer currentPage)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 购物车列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> skuIds</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;ShopCartDTO&gt; <span class="title">shopCarts</span><span class="params">(Long userId, List&lt;Long&gt; skuIds)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除购物车指定sku</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> skuIds skuID数组（该参数必须是可变参数或者数组，后面需要转为 byte[][] 类型，如果</span></span><br><span class="line"><span class="comment">     *                 这里用集合的话，后面序列化的 byte[][] 结果是错的）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(Long userId, Long... skuIds)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 清空购物车</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">(Long userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 进入购物车</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 购物车 TotalPage</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Integer <span class="title">into</span><span class="params">(Long userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得当前页的skuIds</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currentPage 当前页码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Long&gt; <span class="title">currentPageSkuIds</span><span class="params">(Long userId, Integer currentPage)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得分组摊平后的购物车</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Long&gt; <span class="title">shopCartGrouping</span><span class="params">(Long userId)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SkuServiceImpl-java"><a href="#SkuServiceImpl-java" class="headerlink" title="SkuServiceImpl.java"></a><code>SkuServiceImpl.java</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fatal.common.enums.ResponseEnum;</span><br><span class="line"><span class="keyword">import</span> com.fatal.common.enums.StatusEnums;</span><br><span class="line"><span class="keyword">import</span> com.fatal.common.exception.ValidateException;</span><br><span class="line"><span class="keyword">import</span> com.fatal.dto.ShopCartSkuDTO;</span><br><span class="line"><span class="keyword">import</span> com.fatal.entity.Sku;</span><br><span class="line"><span class="keyword">import</span> com.fatal.repository.SkuRepository;</span><br><span class="line"><span class="keyword">import</span> com.fatal.service.ISkuService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.AopContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.Cacheable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/14 0014 18:22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SkuServiceImpl</span> <span class="keyword">implements</span> <span class="title">ISkuService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SkuRepository skuRepository;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SkuServiceImpl</span><span class="params">(SkuRepository skuRepository)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.skuRepository = skuRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * sku详情</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@desc</span> 这里的缓存在更新或者删除该sku的时候清理。</span></span><br><span class="line"><span class="comment">     *      为什么这里查找的是上架和下架两个状态的sku。因为下架的sku也需要展示</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Cacheable</span>(cacheNames = <span class="string">"entity:sku"</span>, key = <span class="string">"#id"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Sku <span class="title">getById</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Optional.ofNullable(skuRepository.findByIdAndStatusIsNot(id, StatusEnums.DELETED.getCode()))</span><br><span class="line">                .orElseThrow(() -&gt; <span class="keyword">new</span> ValidateException(ResponseEnum.SKU_IS_NOT_EXISTS));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用于展示的数据。如果还涉及到其他表的数据，可在这里封装。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@desc</span> 这里的缓存在更新或者删除该sku的时候清理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShopCartSkuDTO <span class="title">getShopCartSkuById</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        Sku sku = proxy().getById(id);</span><br><span class="line">        <span class="keyword">return</span> ShopCartSkuDTO.of(sku);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ISkuService <span class="title">proxy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (SkuServiceImpl) AopContext.currentProxy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ShopCartServiceImpl-java"><a href="#ShopCartServiceImpl-java" class="headerlink" title="ShopCartServiceImpl.java"></a><code>ShopCartServiceImpl.java</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fatal.common.constants.ShopCartConstant;</span><br><span class="line"><span class="keyword">import</span> com.fatal.common.enums.ResponseEnum;</span><br><span class="line"><span class="keyword">import</span> com.fatal.common.enums.StatusEnums;</span><br><span class="line"><span class="keyword">import</span> com.fatal.common.exception.ValidateException;</span><br><span class="line"><span class="keyword">import</span> com.fatal.dto.ShopCartDTO;</span><br><span class="line"><span class="keyword">import</span> com.fatal.dto.ShopCartItemDTO;</span><br><span class="line"><span class="keyword">import</span> com.fatal.dto.ShopCartSkuDTO;</span><br><span class="line"><span class="keyword">import</span> com.fatal.service.IShopCartService;</span><br><span class="line"><span class="keyword">import</span> com.fatal.service.ISkuService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.AopContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.CacheEvict;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.Cacheable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.Caching;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.Cursor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.HashOperations;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.ScanOptions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.ObjectUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 购物车服务实现</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/15 0015 8:13</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShopCartServiceImpl</span> <span class="keyword">implements</span> <span class="title">IShopCartService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ISkuService skuService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Serializable&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> HashOperations&lt;String, Object, Object&gt; hashOperations;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ShopCartServiceImpl</span><span class="params">(RedisTemplate&lt;String, Serializable&gt; redisTemplate,</span></span></span><br><span class="line"><span class="function"><span class="params">                               ISkuService skuService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">        <span class="keyword">this</span>.hashOperations = redisTemplate.opsForHash();</span><br><span class="line">        <span class="keyword">this</span>.skuService = skuService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作：1. 新增一个sku</span></span><br><span class="line"><span class="comment">     *      2. 购物车sku项点击 “-”，`购物车sku总数count`减一，前端做判断，等于1的时候不能执行该操作</span></span><br><span class="line"><span class="comment">     *      3. 购物车sku项点击 “+”，`购物车sku总数count`加一</span></span><br><span class="line"><span class="comment">     *      4. 购物车sku项手动填`购物车sku总数count`</span></span><br><span class="line"><span class="comment">     *      其中2和3，都要要求前端根据sku的max限制count（finalValue = count &gt; max ? max : count）</span></span><br><span class="line"><span class="comment">     *      以上的操作，都调用该方法，将`购物车sku总数count`作为第三参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@desc</span> 该方法会对购物车单种sku总个数以及购物车sku种类数量进行控制，并且维护后面用于分组的购物车信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> skuId skuID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> finalValue count 的最终值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Long userId, Long skuId, Long finalValue)</span> </span>&#123;</span><br><span class="line">        ShopCartSkuDTO shopCartSkuDTO = checkSkuIfExists(skuId);</span><br><span class="line">        Integer value = (Integer) hashOperations.get(ShopCartConstant.getCartKey(userId), skuId);</span><br><span class="line">        <span class="keyword">if</span> (ObjectUtils.isEmpty(value)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hashOperations.size(ShopCartConstant.getCartKey(userId)) &gt;= ShopCartConstant.TYPE_MAX) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ValidateException(ResponseEnum.SHOP_CART_SKU_TYPE_COUNT_FULL);</span><br><span class="line">            &#125;</span><br><span class="line">            hashOperations.put(ShopCartConstant.getGroupingKey(userId), skuId, shopCartSkuDTO.getShopId());</span><br><span class="line">        &#125;</span><br><span class="line">        Integer max = ShopCartConstant.MAX &gt; shopCartSkuDTO.getMax() ? shopCartSkuDTO.getMax() : ShopCartConstant.MAX;</span><br><span class="line">        hashOperations.put(ShopCartConstant.getCartKey(userId), skuId, finalValue &gt; max ? max : finalValue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前的 skuIds 然后封装数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currentPage 当前页数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ShopCartDTO&gt; <span class="title">shopCarts</span><span class="params">(Long userId, Integer currentPage)</span> </span>&#123;</span><br><span class="line">        List&lt;Long&gt; skuIds = proxy().currentPageSkuIds(userId, currentPage);</span><br><span class="line">        <span class="keyword">return</span> CollectionUtils.isEmpty(skuIds) ? <span class="keyword">new</span> ArrayList&lt;&gt;() : shopCarts(userId, skuIds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 购物车(skuId)分页缓存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Cacheable</span> unless排除对空集和null的缓存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@desc</span> 使用 Stream#skip + Stream#limit 在流中实现分页</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currentPage 当前页码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Cacheable</span>(unless = <span class="string">"#result == null || #result.size() == 0"</span>, cacheNames = ShopCartConstant.SHOP_CART_PAGE,</span><br><span class="line">            key = <span class="string">"#userId + ':' + #currentPage"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Long&gt; <span class="title">currentPageSkuIds</span><span class="params">(Long userId, Integer currentPage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> proxy().shopCartGrouping(userId).stream()</span><br><span class="line">                .skip((currentPage - <span class="number">1</span>) * ShopCartConstant.PAGE_SIZE)</span><br><span class="line">                .limit(ShopCartConstant.PAGE_SIZE)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得分组摊平后的购物车（未分页的列表）</span></span><br><span class="line"><span class="comment">     * [7,6,4,11,10,8,9,1,12,3,2]</span></span><br><span class="line"><span class="comment">     * 对应三个店铺：[7,6,4],[11,10,8,9],[1,12,3,2]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Cacheable</span>(unless = <span class="string">"#result == null"</span>, cacheNames = ShopCartConstant.SORT_SHOP_CART, key = <span class="string">"#userId"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Long&gt; <span class="title">shopCartGrouping</span><span class="params">(Long userId)</span> </span>&#123;</span><br><span class="line">        Map&lt;Object, Object&gt; map = scan(ShopCartConstant.getGroupingKey(userId));</span><br><span class="line">        List&lt;Map.Entry&lt;Object, Object&gt;&gt; entryList = <span class="keyword">new</span> ArrayList&lt;&gt;(map.entrySet());</span><br><span class="line">        <span class="comment">// 最新加入购物的sku在最后，所以这里得先反序</span></span><br><span class="line">        Collections.reverse(entryList);</span><br><span class="line">        Map&lt;Object, List&lt;Object&gt;&gt; collect = entryList.stream()</span><br><span class="line">                .collect(</span><br><span class="line">                        Collectors.groupingBy(</span><br><span class="line">                                Map.Entry::getValue,</span><br><span class="line">                                <span class="comment">// 得到的key保留原来（作为Entry的value时）的顺序（保存put的顺序）</span></span><br><span class="line">                                LinkedHashMap::<span class="keyword">new</span>,</span><br><span class="line">                                <span class="comment">// 得到的list元素也要保留顺序 Collectors.toList() -&gt; ArrayList（有序）</span></span><br><span class="line">                                Collectors.mapping(Map.Entry::getKey, Collectors.toList())</span><br><span class="line">                        )</span><br><span class="line">                );</span><br><span class="line">        <span class="keyword">return</span> collect.values().stream()</span><br><span class="line">                .flatMap(Collection::stream)</span><br><span class="line">                .map(<span class="keyword">this</span>::toLong)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@step</span></span></span><br><span class="line"><span class="comment">     *   1. 根据 skuIds 获得 shopCartSkuDTOs（封装购物车中sku数量 -&gt; count）</span></span><br><span class="line"><span class="comment">     *   2. 根据 店铺ID 对 shopCartSkuDTOs 进行分组</span></span><br><span class="line"><span class="comment">     *   3. 根据 shopCartSkuDTOs 获得店铺集合（已去重），遍历填充数据</span></span><br><span class="line"><span class="comment">     *      1)去重：这里使用 Stream#distinct 的方式去重，以 "shopId", "shopName" 为标识去除标识重复的数据。在 ShopCartSkuDTO 类上</span></span><br><span class="line"><span class="comment">     *      加上 <span class="doctag">@EqualsAndHashCode</span>(of = &#123;"shopId", "shopName"&#125;) 可以实现，后边调用 Stream#distinct 会在底层使用</span></span><br><span class="line"><span class="comment">     *      equals() 和 hashCode() 方法进行去重。</span></span><br><span class="line"><span class="comment">     *      2)封装：这里使用 Stream#peek 的方式封装，其实可以使用 Stream#map，但是返回类型如果没有改变的话，使用 peek 更直观。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@desc</span> 这个方法的作用就是封装购物车需要展示的数据，参数为带顺序的购物车列表，店铺的顺序由旗下最新添加的商品顺序决定。</span></span><br><span class="line"><span class="comment">     *      展示给前端后，临界值看看是否操作，不需要的话他可以直接拿去展示。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> skuIds skuIds</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ShopCartDTO&gt; <span class="title">shopCarts</span><span class="params">(Long userId, List&lt;Long&gt; skuIds)</span> </span>&#123;</span><br><span class="line">        List&lt;ShopCartSkuDTO&gt; shopCartSkuDTOs = skuIds.stream()</span><br><span class="line">                .map(skuService::getShopCartSkuById)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="comment">// Map&lt;Long, List&lt;ShopCartSkuDTO&gt;&gt; -&gt; Map&lt;shopId, List&lt;ShopCartSkuDTO&gt;&gt;</span></span><br><span class="line">        Map&lt;Long, List&lt;ShopCartSkuDTO&gt;&gt; shopMap = shopCartSkuDTOs.stream()</span><br><span class="line">                .collect(Collectors.groupingBy(ShopCartSkuDTO::getShopId));</span><br><span class="line">        <span class="keyword">return</span> shopCartSkuDTOs.stream()</span><br><span class="line">                .distinct()</span><br><span class="line">                .map(ShopCartDTO::of)</span><br><span class="line">                .peek(shopCartDTO -&gt; &#123;</span><br><span class="line">                    List&lt;ShopCartSkuDTO&gt; subShopCartSkuDTOs = shopMap.get(shopCartDTO.getShopId());</span><br><span class="line">                    List&lt;ShopCartItemDTO&gt; shopCartItemDTOs = ShopCartItemDTO.of(subShopCartSkuDTOs).stream()</span><br><span class="line">                            .peek(shopCartItemDTO -&gt; &#123;</span><br><span class="line">                                Integer count = (Integer) hashOperations.get(ShopCartConstant.getCartKey(userId), shopCartItemDTO.getId());</span><br><span class="line">                                shopCartItemDTO.setCount(count);</span><br><span class="line">                            &#125;).collect(Collectors.toList());</span><br><span class="line">                    shopCartDTO.setItems(shopCartItemDTOs);</span><br><span class="line">                &#125;)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将指定的 sku 从购物车移除。SORT_SHOP_CART 和 SHOP_CART_PAGE 一定会变的，所以需要清除缓存。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> skuIds skuID数组（该参数必须是可变参数或者数组，后面需要转为 byte[][] 类型，如果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Caching</span>(evict = &#123;</span><br><span class="line">            <span class="meta">@CacheEvict</span>(cacheNames = ShopCartConstant.SORT_SHOP_CART, key = <span class="string">"#userId"</span>, beforeInvocation = <span class="keyword">true</span>),</span><br><span class="line">            <span class="meta">@CacheEvict</span>(cacheNames = ShopCartConstant.SHOP_CART_PAGE, key = <span class="string">"#userId"</span>, beforeInvocation = <span class="keyword">true</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(Long userId, Long... skuIds)</span> </span>&#123;</span><br><span class="line">        hashOperations.delete(ShopCartConstant.getCartKey(userId), skuIds);</span><br><span class="line">        hashOperations.delete(ShopCartConstant.getGroupingKey(userId), skuIds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 清空购物车。</span></span><br><span class="line"><span class="comment">     * 将属于该用户的购物车数据全部删除。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Caching</span>(evict = &#123;</span><br><span class="line">            <span class="meta">@CacheEvict</span>(cacheNames = ShopCartConstant.SORT_SHOP_CART, key = <span class="string">"#userId"</span>, beforeInvocation = <span class="keyword">true</span>),</span><br><span class="line">            <span class="meta">@CacheEvict</span>(cacheNames = ShopCartConstant.SHOP_CART_PAGE, key = <span class="string">"#userId"</span>, beforeInvocation = <span class="keyword">true</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">(Long userId)</span> </span>&#123;</span><br><span class="line">        redisTemplate.delete(ShopCartConstant.getCartKey(userId));</span><br><span class="line">        redisTemplate.delete(ShopCartConstant.getGroupingKey(userId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">into</span><span class="params">(Long userId)</span> </span>&#123;</span><br><span class="line">        Long size = hashOperations.size(ShopCartConstant.getGroupingKey(userId));</span><br><span class="line">        <span class="keyword">return</span> getTotalPage(size.intValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取购物车总页数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> totalSize</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Integer <span class="title">getTotalPage</span><span class="params">(Integer totalSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> totalSize % ShopCartConstant.PAGE_SIZE == <span class="number">0</span> ?</span><br><span class="line">                totalSize / ShopCartConstant.PAGE_SIZE :</span><br><span class="line">                totalSize / ShopCartConstant.PAGE_SIZE + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * `加入购物车`和`移出购物车`都检验sku是否`上架`</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> skuId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ShopCartSkuDTO <span class="title">checkSkuIfExists</span><span class="params">(Long skuId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 校验 skuId 是否存在（保证数据库存在该sku，且该sku的状态为正常）</span></span><br><span class="line">        ShopCartSkuDTO shopCartSkuDTO = skuService.getShopCartSkuById(skuId);</span><br><span class="line">        <span class="keyword">if</span> (!StatusEnums.NORMAL.getCode().equals(shopCartSkuDTO.getStatus())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidateException(ResponseEnum.SKU_IS_OFF_THE_SHELVES);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> shopCartSkuDTO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Redis 命令 `hgetall` 的时间复杂度为 O(n)，最坏的情况下为 O(120)，所以频繁使用会造成线上服务阻塞</span></span><br><span class="line"><span class="comment">     * Redis 命令 `scan` 的时间复杂度为 O(1)，可以无阻塞的匹配出列表，缺点是可能出现重复数据，这里用 Map 接收</span></span><br><span class="line"><span class="comment">     *      刚好可以解决这个问题，因为要求匹配的数据必须带顺序，所以在本方法中直接用 LinkedHashMap 来实现。</span></span><br><span class="line"><span class="comment">     * Spring Data Redis 中的 scan 方法都帮我们维护了 Cursor 游标值了。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;Object, Object&gt; <span class="title">scan</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        Map&lt;Object, Object&gt; linkedHashMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 设置 count 选项来指定每次迭代返回元素的最大值，设置 match 指定 field 需要匹配的 pattern</span></span><br><span class="line">            Cursor&lt;Map.Entry&lt;Object, Object&gt;&gt; cursor = hashOperations.scan(key,</span><br><span class="line">                    ScanOptions.scanOptions().count(ShopCartConstant.TYPE_MAX).match(<span class="string">"*"</span>).build());</span><br><span class="line">            <span class="comment">// 带顺序的 HashMap，同一个元素就算被返回多次也不影响。</span></span><br><span class="line">            <span class="keyword">while</span> (cursor.hasNext()) &#123;</span><br><span class="line">                Map.Entry&lt;Object, Object&gt; entry = cursor.next();</span><br><span class="line">                linkedHashMap.put(entry.getKey(), entry.getValue());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 关闭游标，释放资源</span></span><br><span class="line">            cursor.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> linkedHashMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> IShopCartService <span class="title">proxy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (ShopCartServiceImpl) AopContext.currentProxy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Long <span class="title">toLong</span><span class="params">(Object id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id <span class="keyword">instanceof</span> Long?</span><br><span class="line">                (Long) id :</span><br><span class="line">                Long.valueOf(((Integer) id).longValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="11、controller"><a href="#11、controller" class="headerlink" title="11、controller"></a>11、controller</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fatal.dto.ShopCartDTO;</span><br><span class="line"><span class="keyword">import</span> com.fatal.service.IShopCartService;</span><br><span class="line"><span class="keyword">import</span> com.fatal.vo.ShopCartVO;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.annotation.Validated;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.Min;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.NotEmpty;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.NotNull;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/16 0016 12:54</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/shopCart"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShopCartController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> IShopCartService shopCartService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ShopCartController</span><span class="params">(IShopCartService shopCartService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.shopCartService = shopCartService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping</span>(<span class="string">"/put"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;Void&gt; <span class="title">put</span><span class="params">(@NotNull(message = <span class="string">"userId不能为空"</span>)</span> Long userId,</span></span><br><span class="line"><span class="function">                                    @<span class="title">NotNull</span><span class="params">(message = <span class="string">"skuId不能为空"</span>)</span> Long skuId,</span></span><br><span class="line"><span class="function">                                    @<span class="title">NotNull</span><span class="params">(message = <span class="string">"finalValue不能为空"</span>)</span></span></span><br><span class="line"><span class="function">                                    @<span class="title">Min</span><span class="params">(value = <span class="number">1</span>, message = <span class="string">"finalValue不能小于&#123;value&#125;"</span>)</span> Long finalValue) </span>&#123;</span><br><span class="line">        shopCartService.put(userId, skuId, finalValue);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/shopCarts"</span>)</span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;List&lt;ShopCartVO&gt;&gt; shopCarts(<span class="meta">@NotNull</span>(message = <span class="string">"userId不能为空"</span>) Long userId,</span><br><span class="line">                                                      <span class="meta">@NotNull</span>(message = <span class="string">"currentPage不能为空"</span>)</span><br><span class="line">                                                      <span class="meta">@Min</span>(value = <span class="number">1</span>, message = <span class="string">"currentPage不能小于&#123;value&#125;"</span>) Integer currentPage) &#123;</span><br><span class="line">        List&lt;ShopCartDTO&gt; shopCartDTOs = shopCartService.shopCarts(userId, currentPage);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(ShopCartVO.of(shopCartDTOs));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping</span>(<span class="string">"/remove"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;Void&gt; <span class="title">remove</span><span class="params">(@NotNull(message = <span class="string">"userId不能为空"</span>)</span> Long userId,</span></span><br><span class="line"><span class="function">                                       @<span class="title">NotEmpty</span><span class="params">(message = <span class="string">"skuIds不能为空"</span>)</span> Long... skuIds) </span>&#123;</span><br><span class="line">        shopCartService.remove(userId, skuIds);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping</span>(<span class="string">"/clear"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;Void&gt; <span class="title">clear</span><span class="params">(@NotNull(message = <span class="string">"userId不能为空"</span>)</span> Long userId) </span>&#123;</span><br><span class="line">        shopCartService.clear(userId);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;Integer&gt; <span class="title">into</span><span class="params">(@NotNull(message = <span class="string">"userId不能为空"</span>)</span> Long userId) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(shopCartService.into(userId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="12、Application"><a href="#12、Application" class="headerlink" title="12、Application"></a>12、Application</h2><p>加两个配置：</p>
<ul>
<li>启用缓存</li>
<li>暴露代理</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.EnableCaching;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.EnableAspectJAutoProxy;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableCaching</span> <span class="comment">// 启用缓存</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span>(exposeProxy = <span class="keyword">true</span>) <span class="comment">// 暴露代理</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Chapter29Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Chapter29Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="13、Test"><a href="#13、Test" class="headerlink" title="13、Test"></a>13、Test</h2><h3 id="ShopCartServiceImplTest-java"><a href="#ShopCartServiceImplTest-java" class="headerlink" title="ShopCartServiceImplTest.java"></a><code>ShopCartServiceImplTest.java</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fatal.Chapter29ApplicationTests;</span><br><span class="line"><span class="keyword">import</span> com.fatal.common.utils.JsonUtil;</span><br><span class="line"><span class="keyword">import</span> com.fatal.dto.ShopCartDTO;</span><br><span class="line"><span class="keyword">import</span> com.fatal.service.IShopCartService;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/15 0015 8:54</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShopCartServiceImplTest</span> <span class="keyword">extends</span> <span class="title">Chapter29ApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long userId = <span class="number">999999L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IShopCartService shopCartService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">incrementOne</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        shopCartService.put(userId, <span class="number">1L</span>, <span class="number">101L</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        shopCartService.put(userId,<span class="number">2L</span>, <span class="number">100L</span>);</span><br><span class="line">        shopCartService.put(userId,<span class="number">4L</span>, <span class="number">100L</span>);</span><br><span class="line">        shopCartService.put(userId,<span class="number">9L</span>, <span class="number">100L</span>);</span><br><span class="line">        shopCartService.put(userId,<span class="number">3L</span>, <span class="number">100L</span>);</span><br><span class="line">        shopCartService.put(userId,<span class="number">8L</span>, <span class="number">100L</span>);</span><br><span class="line">        shopCartService.put(userId,<span class="number">12L</span>, <span class="number">100L</span>);</span><br><span class="line">        shopCartService.put(userId,<span class="number">1L</span>, <span class="number">100L</span>);</span><br><span class="line">        shopCartService.put(userId,<span class="number">6L</span>, <span class="number">100L</span>);</span><br><span class="line">        shopCartService.put(userId,<span class="number">10L</span>, <span class="number">100L</span>);</span><br><span class="line">        shopCartService.put(userId,<span class="number">11L</span>, <span class="number">100L</span>);</span><br><span class="line">        shopCartService.put(userId,<span class="number">7L</span>, <span class="number">100L</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shopCarts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;ShopCartDTO&gt; shopCartDTOs = shopCartService.shopCarts(userId, <span class="number">3</span>);</span><br><span class="line">        String json = JsonUtil.toJson(shopCartDTOs);</span><br><span class="line">        System.out.println(json);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Long[] skuIds = <span class="keyword">new</span> Long[]&#123;<span class="number">7L</span>, <span class="number">10L</span>, <span class="number">2L</span>&#125;;</span><br><span class="line">        shopCartService.remove(userId, skuIds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        shopCartService.clear(userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">into</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Integer totalPage = shopCartService.into(userId);</span><br><span class="line">        System.out.println(totalPage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shopCartGrouping</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Long&gt; list = shopCartService.shopCartGrouping(userId);</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="RedisTests"><a href="#RedisTests" class="headerlink" title="RedisTests"></a>RedisTests</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fatal.redis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fatal.Chapter29ApplicationTests;</span><br><span class="line"><span class="keyword">import</span> com.fatal.common.constants.ShopCartConstant;</span><br><span class="line"><span class="keyword">import</span> com.fatal.dto.RedisTestDTO;</span><br><span class="line"><span class="keyword">import</span> com.fatal.entity.Sku;</span><br><span class="line"><span class="keyword">import</span> com.fatal.common.enums.StatusEnums;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 执行完放可以输入 redis 命令 &gt; object encoding [key] 来查看底层数据结构</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fatal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/8/16 0016 9:44</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisTests</span> <span class="keyword">extends</span> <span class="title">Chapter29ApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Serializable&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Sku sku;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RedisTestDTO redisTestDTO;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sku = <span class="keyword">new</span> Sku()</span><br><span class="line">                .setGoodsId(<span class="number">111111L</span>)</span><br><span class="line">                .setShopId(<span class="number">123457L</span>)</span><br><span class="line">                .setShopName(<span class="string">"MiCai Shop"</span>)</span><br><span class="line">                .setGoodsName(<span class="string">"帆布鞋"</span>)</span><br><span class="line">                .setPrice(<span class="number">15000L</span>)</span><br><span class="line">                .setStock(<span class="number">100</span>)</span><br><span class="line">                .setPicture(<span class="string">"http://...pic...123.png"</span>)</span><br><span class="line">                .setProperties(<span class="string">"白色;40"</span>)</span><br><span class="line">                .setMax(<span class="number">300</span>)</span><br><span class="line">                .setStatus(StatusEnums.NORMAL.getCode())</span><br><span class="line">                .setCreateTime(LocalDateTime.now())</span><br><span class="line">                .setUpdateTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">        redisTestDTO = <span class="keyword">new</span> RedisTestDTO()</span><br><span class="line">                .setSkuId(Long.MAX_VALUE)</span><br><span class="line">                .setCount(ShopCartConstant.MAX);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">zSetTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String key = <span class="string">"ZSET_TEST"</span>;</span><br><span class="line">        ZSetOperations&lt;String, Serializable&gt; zSetOperations = redisTemplate.opsForZSet();</span><br><span class="line">        zSetOperations.add(key, redisTestDTO, <span class="number">1</span>);   <span class="comment">// skiplist</span></span><br><span class="line">        Set&lt;Serializable&gt; range = zSetOperations.range(key, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">assert</span> range != <span class="keyword">null</span>;</span><br><span class="line">        range.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hashTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HashOperations&lt;String, Object, Object&gt; hashOperations = redisTemplate.opsForHash();</span><br><span class="line">        hashOperations.put(<span class="string">"Cart"</span>, <span class="string">"用户id"</span>, sku);</span><br><span class="line">        Sku result = (Sku) hashOperations.get(<span class="string">"Cart"</span>, <span class="string">"用户id"</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stringTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ValueOperations&lt;String, Serializable&gt; valueOperations = redisTemplate.opsForValue();</span><br><span class="line">        valueOperations.set(<span class="string">"SKU"</span>, sku);</span><br><span class="line">        Serializable sku = valueOperations.get(<span class="string">"SKU"</span>);</span><br><span class="line">        System.out.println(sku);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String key = <span class="string">"LIST_TEST"</span>;</span><br><span class="line">        ListOperations&lt;String, Serializable&gt; listOperations = redisTemplate.opsForList();</span><br><span class="line">        listOperations.leftPush(key, redisTestDTO);</span><br><span class="line">        List&lt;Serializable&gt; range = listOperations.range(key, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">assert</span> range != <span class="keyword">null</span>;</span><br><span class="line">        range.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="14、测试"><a href="#14、测试" class="headerlink" title="14、测试"></a>14、测试</h2><p>由于数据不多，下面的测试设置了 <code>pageSize</code> 为 <strong>4</strong> 方便看。</p>
<h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><ul>
<li><code>SHOP_CART</code>：购物车，放<code>SkuId</code>以及它对应的数量</li>
<li><code>SHOP_CART_FOR_GROUPING</code>：用于分组的购物车，放<code>SkuId</code>及对应的<code>店铺ID</code>（后续需要按店铺分组）</li>
<li><code>SORT_SHOP_CART</code>：排序购物车，经过<strong>分组和摊平</strong>操作之后的 <code>SkuIds</code>（缓存）</li>
<li><code>SHOP_CART_PAGE</code>：购物车分页所包含的<code>SkuIds</code>（根据排序购物车计算得出）（缓存）</li>
<li><code>entity:sku</code>：实体（缓存）</li>
</ul>
<h3 id="初始化数据"><a href="#初始化数据" class="headerlink" title="初始化数据"></a>初始化数据</h3><p>运行 <code>ShopCartServiceImplTest.init()</code></p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590934870261.png" alt="1590934870261"></p>
<h3 id="保存购物车"><a href="#保存购物车" class="headerlink" title="保存购物车"></a>保存购物车</h3><blockquote>
<p>不管是四项操作中的哪一项，只要把 <code>count</code> 最终值作为第三参数传给后台即可</p>
</blockquote>
<p>访问  <code>localhost:8080/shopCart/put</code>，参数自己填充</p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1591516587177.png" alt="1591516587177"></p>
<p><code>Redis</code> 视图界面：</p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590935210388.png" alt="1590935210388"></p>
<h3 id="进入购物车"><a href="#进入购物车" class="headerlink" title="进入购物车"></a>进入购物车</h3><p>访问 <code>localhost:8080/shopCart?userId=999999</code></p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1566196424378.png" alt="1566196424378"></p>
<p>响应：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3 // 总页数</span><br></pre></td></tr></table></figure>
<h3 id="购物车列表"><a href="#购物车列表" class="headerlink" title="购物车列表"></a>购物车列表</h3><p>从上个接口可以得出现在有3页</p>
<h4 id="首先看看第一页"><a href="#首先看看第一页" class="headerlink" title="首先看看第一页"></a>首先看看第一页</h4><p>访问 <code>localhost:8080/shopCart/shopCarts?userId=999999&amp;currentPage=1</code></p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1566196407427.png" alt="1566196407427"></p>
<p>先看看 <code>Redis</code> 视图化界面：</p>
<p><code>SORT_SHOP_CART</code> 中 <code>skuId</code> 的顺序：</p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590935412948.png" alt="1590935412948"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">7</span>,<span class="number">6</span>,<span class="number">4</span>,<span class="number">11</span>,<span class="number">10</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">1</span>,<span class="number">12</span>,<span class="number">3</span>,<span class="number">2</span>]</span><br></pre></td></tr></table></figure>
<p>再来看看<code>SHOP_CART_PAGE</code>第一页的<code>skuId</code>：</p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590935518869.png" alt="1590935518869"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">7</span>,<span class="number">6</span>,<span class="number">4</span>,<span class="number">11</span>]</span><br></pre></td></tr></table></figure>
<p>再来看看响应的数据是否一致：</p>
<p>从这里可以看出，<code>skuId</code> 为 7 的 <code>sku</code> 是<strong>最新添加</strong>的，所以，它所属的店铺信息排在<strong>最前边</strong>。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"shopId"</span>: <span class="number">123456</span>,</span><br><span class="line">        <span class="attr">"shopName"</span>: <span class="string">"Fatal Shop"</span>,</span><br><span class="line">        <span class="attr">"items"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"id"</span>: <span class="number">7</span>,</span><br><span class="line">                <span class="attr">"goodsName"</span>: <span class="string">"限量款骑士领带"</span>,</span><br><span class="line">                <span class="attr">"price"</span>: <span class="number">521000</span>,</span><br><span class="line">                <span class="attr">"picture"</span>: <span class="string">"http://...pic...123.png"</span>,</span><br><span class="line">                <span class="attr">"properties"</span>: <span class="string">"棕色"</span>,</span><br><span class="line">                <span class="attr">"max"</span>: <span class="number">2</span>,</span><br><span class="line">                <span class="attr">"count"</span>: <span class="number">2</span>,</span><br><span class="line">                <span class="attr">"status"</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"id"</span>: <span class="number">6</span>,</span><br><span class="line">                <span class="attr">"goodsName"</span>: <span class="string">"男士皮鞋"</span>,</span><br><span class="line">                <span class="attr">"price"</span>: <span class="number">221000</span>,</span><br><span class="line">                <span class="attr">"picture"</span>: <span class="string">"http://...pic...123.png"</span>,</span><br><span class="line">                <span class="attr">"properties"</span>: <span class="string">"43;黑色编织镂空款B1923913"</span>,</span><br><span class="line">                <span class="attr">"max"</span>: <span class="number">500</span>,</span><br><span class="line">                <span class="attr">"count"</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">"status"</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"id"</span>: <span class="number">4</span>,</span><br><span class="line">                <span class="attr">"goodsName"</span>: <span class="string">"男士皮鞋"</span>,</span><br><span class="line">                <span class="attr">"price"</span>: <span class="number">221000</span>,</span><br><span class="line">                <span class="attr">"picture"</span>: <span class="string">"http://...pic...123.png"</span>,</span><br><span class="line">                <span class="attr">"properties"</span>: <span class="string">"40;黑色编织镂空款B1923913"</span>,</span><br><span class="line">                <span class="attr">"max"</span>: <span class="number">500</span>,</span><br><span class="line">                <span class="attr">"count"</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">"status"</span>: <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"shopId"</span>: <span class="number">123458</span>,</span><br><span class="line">        <span class="attr">"shopName"</span>: <span class="string">"MiQI Shop"</span>,</span><br><span class="line">        <span class="attr">"items"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"id"</span>: <span class="number">11</span>,</span><br><span class="line">                <span class="attr">"goodsName"</span>: <span class="string">"胸针"</span>,</span><br><span class="line">                <span class="attr">"price"</span>: <span class="number">211000</span>,</span><br><span class="line">                <span class="attr">"picture"</span>: <span class="string">"http://...pic...123.png"</span>,</span><br><span class="line">                <span class="attr">"properties"</span>: <span class="string">"骑士银"</span>,</span><br><span class="line">                <span class="attr">"max"</span>: <span class="number">10</span>,</span><br><span class="line">                <span class="attr">"count"</span>: <span class="number">10</span>,</span><br><span class="line">                <span class="attr">"status"</span>: <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>debug 了 <code>ShopCartServiceImpl#shopCarts</code> 的方法，下图是该方法的第三步的流程图。</p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590922792410.png" alt="1590922792410"></p>
<blockquote>
<p>其实，按照 <code>stream</code> 的方式在 <code>map</code> 之后 items 是没有数据的，不过 idea 它这里显示的是现在时，也就是当前状态，所以 <code>peek</code> 之后的数据在这里也展示了。</p>
</blockquote>
<h4 id="接着来看看第二页"><a href="#接着来看看第二页" class="headerlink" title="接着来看看第二页"></a>接着来看看第二页</h4><p>访问 <code>localhost:8080/shopCart/shopCarts?userId=999999&amp;currentPage=2</code></p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1566402745570.png" alt="1566402745570"></p>
<p>还是先看 <code>Redis</code> 视图化界面：</p>
<p>你会发现，<code>SHOP_CART_PAGE</code>第二页的<code>skuId</code>也正常</p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590935676206.png" alt="1590935676206"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">10</span>,,<span class="number">8</span>,<span class="number">9</span>,<span class="number">1</span>]</span><br></pre></td></tr></table></figure>
<p>再来看看响应的数据是否一致，发现数据也正常。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"shopId"</span>: <span class="number">123458</span>,</span><br><span class="line">        <span class="attr">"shopName"</span>: <span class="string">"MiQI Shop"</span>,</span><br><span class="line">        <span class="attr">"items"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"id"</span>: <span class="number">10</span>,</span><br><span class="line">                <span class="attr">"goodsName"</span>: <span class="string">"男士中邦皮靴"</span>,</span><br><span class="line">                <span class="attr">"price"</span>: <span class="number">111000</span>,</span><br><span class="line">                <span class="attr">"picture"</span>: <span class="string">"http://...pic...123.png"</span>,</span><br><span class="line">                <span class="attr">"properties"</span>: <span class="string">"40;豹纹"</span>,</span><br><span class="line">                <span class="attr">"max"</span>: <span class="number">200</span>,</span><br><span class="line">                <span class="attr">"count"</span>: <span class="number">102</span>,</span><br><span class="line">                <span class="attr">"status"</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"id"</span>: <span class="number">8</span>,</span><br><span class="line">                <span class="attr">"goodsName"</span>: <span class="string">"女生西装"</span>,</span><br><span class="line">                <span class="attr">"price"</span>: <span class="number">1121000</span>,</span><br><span class="line">                <span class="attr">"picture"</span>: <span class="string">"http://...pic...123.png"</span>,</span><br><span class="line">                <span class="attr">"properties"</span>: <span class="string">"L;灰色"</span>,</span><br><span class="line">                <span class="attr">"max"</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">"count"</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">"status"</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"id"</span>: <span class="number">9</span>,</span><br><span class="line">                <span class="attr">"goodsName"</span>: <span class="string">"男士西装"</span>,</span><br><span class="line">                <span class="attr">"price"</span>: <span class="number">911000</span>,</span><br><span class="line">                <span class="attr">"picture"</span>: <span class="string">"http://...pic...123.png"</span>,</span><br><span class="line">                <span class="attr">"properties"</span>: <span class="string">"XL;灰色"</span>,</span><br><span class="line">                <span class="attr">"max"</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">"count"</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">"status"</span>: <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"shopId"</span>: <span class="number">123457</span>,</span><br><span class="line">        <span class="attr">"shopName"</span>: <span class="string">"MiCai Shop"</span>,</span><br><span class="line">        <span class="attr">"items"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">"goodsName"</span>: <span class="string">"帆布鞋"</span>,</span><br><span class="line">                <span class="attr">"price"</span>: <span class="number">55000</span>,</span><br><span class="line">                <span class="attr">"picture"</span>: <span class="string">"http://...pic...123.png"</span>,</span><br><span class="line">                <span class="attr">"properties"</span>: <span class="string">"白色;40"</span>,</span><br><span class="line">                <span class="attr">"max"</span>: <span class="number">300</span>,</span><br><span class="line">                <span class="attr">"count"</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">"status"</span>: <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h4 id="看看最后一页"><a href="#看看最后一页" class="headerlink" title="看看最后一页"></a>看看最后一页</h4><p>访问 <code>localhost:8080/shopCart/shopCarts?userId=999999&amp;currentPage=3</code></p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1566402980408.png" alt="1566402980408"></p>
<p>刷新下 <code>Redis</code> 视图化界面，<code>SHOP_CART_PAGE</code>第三页的 <code>skuId</code>也正常：</p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590935762300.png" alt="1590935762300"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">12</span>,<span class="number">3</span>,<span class="number">2</span>]</span><br></pre></td></tr></table></figure>
<p>再来看看响应的数据，发现都正常…</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"shopId"</span>: <span class="number">123457</span>,</span><br><span class="line">        <span class="attr">"shopName"</span>: <span class="string">"MiCai Shop"</span>,</span><br><span class="line">        <span class="attr">"items"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"id"</span>: <span class="number">12</span>,</span><br><span class="line">                <span class="attr">"goodsName"</span>: <span class="string">"胸针"</span>,</span><br><span class="line">                <span class="attr">"price"</span>: <span class="number">191000</span>,</span><br><span class="line">                <span class="attr">"picture"</span>: <span class="string">"http://...pic...123.png"</span>,</span><br><span class="line">                <span class="attr">"properties"</span>: <span class="string">"骑士蓝"</span>,</span><br><span class="line">                <span class="attr">"max"</span>: <span class="number">10</span>,</span><br><span class="line">                <span class="attr">"count"</span>: <span class="number">10</span>,</span><br><span class="line">                <span class="attr">"status"</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"id"</span>: <span class="number">3</span>,</span><br><span class="line">                <span class="attr">"goodsName"</span>: <span class="string">"太阳帽"</span>,</span><br><span class="line">                <span class="attr">"price"</span>: <span class="number">21000</span>,</span><br><span class="line">                <span class="attr">"picture"</span>: <span class="string">"http://...pic...123.png"</span>,</span><br><span class="line">                <span class="attr">"properties"</span>: <span class="string">"蓝色"</span>,</span><br><span class="line">                <span class="attr">"max"</span>: <span class="number">200</span>,</span><br><span class="line">                <span class="attr">"count"</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">"status"</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"id"</span>: <span class="number">2</span>,</span><br><span class="line">                <span class="attr">"goodsName"</span>: <span class="string">"太阳帽"</span>,</span><br><span class="line">                <span class="attr">"price"</span>: <span class="number">21000</span>,</span><br><span class="line">                <span class="attr">"picture"</span>: <span class="string">"http://...pic...123.png"</span>,</span><br><span class="line">                <span class="attr">"properties"</span>: <span class="string">"黑色"</span>,</span><br><span class="line">                <span class="attr">"max"</span>: <span class="number">300</span>,</span><br><span class="line">                <span class="attr">"count"</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">"status"</span>: <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="从购物车移除（部分种类商品）"><a href="#从购物车移除（部分种类商品）" class="headerlink" title="从购物车移除（部分种类商品）"></a>从购物车移除（部分种类商品）</h3><p>访问 <code>localhost:8080/shopCart/remove</code>，参数自己填充（7,10,3）</p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1566197174800.png" alt="1566197174800"></p>
<p><code>Redis</code> 视图界面：</p>
<p>你会发现 <code>SORT_SHOP_CART</code>、<code>SHOP_CART_PAGE</code>这两组缓存数据被清理了</p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590935982070.png" alt="1590935982070"></p>
<p>并且 <code>SHOP_CART</code> 和 <code>SHOP_CART_FOR_GROUPING</code>的数据也更新了</p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590936038160.png" alt="1590936038160"></p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590936092745.png" alt="1590936092745"></p>
<h4 id="再测试下查询，看看数据是否正常"><a href="#再测试下查询，看看数据是否正常" class="headerlink" title="再测试下查询，看看数据是否正常"></a>再测试下查询，看看数据是否正常</h4><p>先访问<code>localhost:8080/shopCart?userId=999999</code>，得到的总页数为：<code>2</code></p>
<p>接着分别访问<code>localhost:8080/shopCart/shopCarts?userId=999999&amp;currentPage=1</code>和<code>currentPage为 2</code>的。</p>
<p><code>Redis</code> 视图化界面：</p>
<p><code>SORT_SHOP_CART</code>：</p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590936365922.png" alt="1590936365922"></p>
<p><code>SHOP_CART_PAGE</code>的第一页：</p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590936436068.png" alt="1590936436068"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">11</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">6</span>]</span><br></pre></td></tr></table></figure>
<p><code>SHOP_CART_PAGE</code>的第二页：</p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590936489208.png" alt="1590936489208"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">4</span>,<span class="number">1</span>,<span class="number">12</span>,<span class="number">2</span>]</span><br></pre></td></tr></table></figure>
<p>再看看响应</p>
<p>第一页响应：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"shopId"</span>: <span class="number">123458</span>,</span><br><span class="line">        <span class="attr">"shopName"</span>: <span class="string">"MiQI Shop"</span>,</span><br><span class="line">        <span class="attr">"items"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"id"</span>: <span class="number">11</span>,</span><br><span class="line">                <span class="attr">"goodsName"</span>: <span class="string">"胸针"</span>,</span><br><span class="line">                <span class="attr">"price"</span>: <span class="number">211000</span>,</span><br><span class="line">                <span class="attr">"picture"</span>: <span class="string">"http://...pic...123.png"</span>,</span><br><span class="line">                <span class="attr">"properties"</span>: <span class="string">"骑士银"</span>,</span><br><span class="line">                <span class="attr">"max"</span>: <span class="number">10</span>,</span><br><span class="line">                <span class="attr">"count"</span>: <span class="number">10</span>,</span><br><span class="line">                <span class="attr">"status"</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"id"</span>: <span class="number">8</span>,</span><br><span class="line">                <span class="attr">"goodsName"</span>: <span class="string">"女生西装"</span>,</span><br><span class="line">                <span class="attr">"price"</span>: <span class="number">1121000</span>,</span><br><span class="line">                <span class="attr">"picture"</span>: <span class="string">"http://...pic...123.png"</span>,</span><br><span class="line">                <span class="attr">"properties"</span>: <span class="string">"L;灰色"</span>,</span><br><span class="line">                <span class="attr">"max"</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">"count"</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">"status"</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"id"</span>: <span class="number">9</span>,</span><br><span class="line">                <span class="attr">"goodsName"</span>: <span class="string">"男士西装"</span>,</span><br><span class="line">                <span class="attr">"price"</span>: <span class="number">911000</span>,</span><br><span class="line">                <span class="attr">"picture"</span>: <span class="string">"http://...pic...123.png"</span>,</span><br><span class="line">                <span class="attr">"properties"</span>: <span class="string">"XL;灰色"</span>,</span><br><span class="line">                <span class="attr">"max"</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">"count"</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">"status"</span>: <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"shopId"</span>: <span class="number">123456</span>,</span><br><span class="line">        <span class="attr">"shopName"</span>: <span class="string">"Fatal Shop"</span>,</span><br><span class="line">        <span class="attr">"items"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"id"</span>: <span class="number">6</span>,</span><br><span class="line">                <span class="attr">"goodsName"</span>: <span class="string">"男士皮鞋"</span>,</span><br><span class="line">                <span class="attr">"price"</span>: <span class="number">221000</span>,</span><br><span class="line">                <span class="attr">"picture"</span>: <span class="string">"http://...pic...123.png"</span>,</span><br><span class="line">                <span class="attr">"properties"</span>: <span class="string">"43;黑色编织镂空款B1923913"</span>,</span><br><span class="line">                <span class="attr">"max"</span>: <span class="number">500</span>,</span><br><span class="line">                <span class="attr">"count"</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">"status"</span>: <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>第二页响应：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"shopId"</span>: <span class="number">123456</span>,</span><br><span class="line">        <span class="attr">"shopName"</span>: <span class="string">"Fatal Shop"</span>,</span><br><span class="line">        <span class="attr">"items"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"id"</span>: <span class="number">4</span>,</span><br><span class="line">                <span class="attr">"goodsName"</span>: <span class="string">"男士皮鞋"</span>,</span><br><span class="line">                <span class="attr">"price"</span>: <span class="number">221000</span>,</span><br><span class="line">                <span class="attr">"picture"</span>: <span class="string">"http://...pic...123.png"</span>,</span><br><span class="line">                <span class="attr">"properties"</span>: <span class="string">"40;黑色编织镂空款B1923913"</span>,</span><br><span class="line">                <span class="attr">"max"</span>: <span class="number">500</span>,</span><br><span class="line">                <span class="attr">"count"</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">"status"</span>: <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"shopId"</span>: <span class="number">123457</span>,</span><br><span class="line">        <span class="attr">"shopName"</span>: <span class="string">"MiCai Shop"</span>,</span><br><span class="line">        <span class="attr">"items"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">"goodsName"</span>: <span class="string">"帆布鞋"</span>,</span><br><span class="line">                <span class="attr">"price"</span>: <span class="number">55000</span>,</span><br><span class="line">                <span class="attr">"picture"</span>: <span class="string">"http://...pic...123.png"</span>,</span><br><span class="line">                <span class="attr">"properties"</span>: <span class="string">"白色;40"</span>,</span><br><span class="line">                <span class="attr">"max"</span>: <span class="number">300</span>,</span><br><span class="line">                <span class="attr">"count"</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">"status"</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"id"</span>: <span class="number">12</span>,</span><br><span class="line">                <span class="attr">"goodsName"</span>: <span class="string">"胸针"</span>,</span><br><span class="line">                <span class="attr">"price"</span>: <span class="number">191000</span>,</span><br><span class="line">                <span class="attr">"picture"</span>: <span class="string">"http://...pic...123.png"</span>,</span><br><span class="line">                <span class="attr">"properties"</span>: <span class="string">"骑士蓝"</span>,</span><br><span class="line">                <span class="attr">"max"</span>: <span class="number">10</span>,</span><br><span class="line">                <span class="attr">"count"</span>: <span class="number">10</span>,</span><br><span class="line">                <span class="attr">"status"</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"id"</span>: <span class="number">2</span>,</span><br><span class="line">                <span class="attr">"goodsName"</span>: <span class="string">"太阳帽"</span>,</span><br><span class="line">                <span class="attr">"price"</span>: <span class="number">21000</span>,</span><br><span class="line">                <span class="attr">"picture"</span>: <span class="string">"http://...pic...123.png"</span>,</span><br><span class="line">                <span class="attr">"properties"</span>: <span class="string">"黑色"</span>,</span><br><span class="line">                <span class="attr">"max"</span>: <span class="number">300</span>,</span><br><span class="line">                <span class="attr">"count"</span>: <span class="number">99</span>,</span><br><span class="line">                <span class="attr">"status"</span>: <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>响应数据跟缓存数据一致。</p>
<h3 id="清空购物车"><a href="#清空购物车" class="headerlink" title="清空购物车"></a>清空购物车</h3><p>访问 <code>localhost:8080/shopCart/clear</code>，参数自己填充</p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1566197287007.png" alt="1566197287007"></p>
<p><code>Redis</code> 视图界面：</p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1590936664436.png" alt="1590936664436"></p>
<p>只剩下实体的缓存</p>
<h3 id="展示"><a href="#展示" class="headerlink" title="展示"></a>展示</h3><p>首先，前后端约定每次下拉最多刷新多少<code>sku</code>，这篇笔记以 <strong>16</strong> 为例子。</p>
<p>前端拿 <code>购物车列表</code> 直接展示即可。</p>
<h4 id="临界值"><a href="#临界值" class="headerlink" title="临界值"></a>临界值</h4><p>第一种情况：假设现在用户购物车有 30 个 <code>sku</code>。用户第一次查出了<strong>16</strong>条记录中，最后一条记录属于店铺 <code>Fatal Shop</code>。当用户向下拉的时候，前端将会拿接下来的<strong>14</strong>个<code>skuId</code>，问题来了，第二次这 <strong>14</strong> 个 <code>sku</code> 的前两个 <code>sku</code>也属于店铺 <code>Fatal Shop</code>，这是出现以下的数据：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// 这是进入购物车后首次展示的16个sku.</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;,...</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"shopId"</span>: <span class="number">123456</span>,</span><br><span class="line">        <span class="attr">"shopName"</span>: <span class="string">"Fatal Shop"</span>,</span><br><span class="line">        <span class="attr">"items"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                "id": 12,...</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">// 这是第二次刷新需要展示的14个sku.</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"shopId"</span>: <span class="number">123456</span>,</span><br><span class="line">        <span class="attr">"shopName"</span>: <span class="string">"Fatal Shop"</span>,</span><br><span class="line">        <span class="attr">"items"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                "id": 4,...</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                "id": 6,...</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>那么，这时候需要合并。首先，刷新之前先拿到上一页<strong>最后一个</strong>店铺id。刷新之后，与<strong>下页的第一个</strong>店铺id进行比较，如果相等，则将下页第一个店铺的<code>items</code>数据追加在上一页最后一家店铺的<code>items</code>中，然后下页其它店铺的数据正常显示；如果不相等，直接渲染即可。</p>
<h2 id="查看-Redis-底层实现"><a href="#查看-Redis-底层实现" class="headerlink" title="查看 Redis 底层实现"></a>查看 Redis 底层实现</h2><blockquote>
<p>只举例 <code>zset</code> ，其它根据需要自己测。</p>
</blockquote>
<p>执行 <code>RedisTests.zSetTest()</code> 方法</p>
<p>使用 <code>redis-cli</code> 输入命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; object encoding &quot;ZSET_TEST&quot;</span><br></pre></td></tr></table></figure>
<p>显示如下图</p>
<p><img src="/images/SpringBoot2/SpringBoot使用Redis实现购物车/1591508385302.png" alt="1591508385302"></p>
<h2 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h2><h3 id="问题：使用Json方式序列化和反序列化，LocalDateTime-没有无参构造怎么处理？"><a href="#问题：使用Json方式序列化和反序列化，LocalDateTime-没有无参构造怎么处理？" class="headerlink" title="问题：使用Json方式序列化和反序列化，LocalDateTime 没有无参构造怎么处理？"></a>问题：使用<code>Json</code>方式序列化和反序列化，<code>LocalDateTime</code> 没有无参构造怎么处理？</h3><h3 id="解决方式："><a href="#解决方式：" class="headerlink" title="解决方式："></a>解决方式：</h3><p>在该属性上面添加两个注解，分别制定<code>序列化器</code>和<code>反序列化器</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonDeserialize</span>(using = LocalDateTimeDeserializer.class)</span><br><span class="line"><span class="meta">@JsonSerialize</span>(using = LocalDateTimeSerializer.class)</span><br><span class="line"><span class="keyword">private</span> LocalDateTime createTime;</span><br></pre></td></tr></table></figure>
<h3 id="查看-Redis-底层实现的命令"><a href="#查看-Redis-底层实现的命令" class="headerlink" title="查看 Redis 底层实现的命令"></a>查看 Redis 底层实现的命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">redis&gt;</span><span class="bash"> object encoding [key] </span></span><br><span class="line">"ziplist"</span><br></pre></td></tr></table></figure>
<h3 id="Redis-的增量式迭代"><a href="#Redis-的增量式迭代" class="headerlink" title="Redis 的增量式迭代"></a>Redis 的增量式迭代</h3><p><a href="http://www.redis.cn/commands/scan.html" target="_blank" rel="noopener">SCAN</a> 命令及其相关的 <a href="http://www.redis.cn/commands/sscan.html" target="_blank" rel="noopener">SSCAN</a>, <a href="http://www.redis.cn/commands/hscan.html" target="_blank" rel="noopener">HSCAN</a> 和 <a href="http://www.redis.cn/commands/zscan.html" target="_blank" rel="noopener">ZSCAN</a> 命令都用于增量迭代一个集合元素。</p>
<ul>
<li><a href="http://www.redis.cn/commands/scan.html" target="_blank" rel="noopener">SCAN</a> 命令用于迭代当前数据库中的<code>key</code>集合。</li>
<li><a href="http://www.redis.cn/commands/sscan.html" target="_blank" rel="noopener">SSCAN</a> 命令用于迭代<code>SET</code>集合中的元素。</li>
<li><a href="http://www.redis.cn/commands/hscan.html" target="_blank" rel="noopener">HSCAN</a> 命令用于迭代<code>Hash</code>类型中的键值对。</li>
<li><a href="http://www.redis.cn/commands/zscan.html" target="_blank" rel="noopener">ZSCAN</a> 命令用于迭代<code>SortSet</code>集合中的元素和元素对应的分值</li>
</ul>
<blockquote>
<p> 增量式迭代：可以在迭代的过程中对集合进行元素操作，包括<code>增加、修改、删除</code>。</p>
<p>概念具体可以参考（从 <a href="http://www.redis.cn/commands/scan.html" target="_blank" rel="noopener">scan 命令</a> 摘取）</p>
<ul>
<li>这类增量式迭代命令来说，有可能在增量迭代过程中，集合元素被修改，对返回值无法提供完全准确的保证。</li>
<li>如果一个元素是在迭代过程中被添加到数据集的， 又或者是在迭代过程中从数据集中被删除的， 那么这个元素可能会被返回， 也可能不会。</li>
</ul>
</blockquote>
<p>更多关于 <code>Redis scan</code> 命令的信息请查看 <a href="http://www.redis.cn/commands/scan.html" target="_blank" rel="noopener">scan 命令</a>。</p>
<h3 id="提交订单后-Sku-何去何从"><a href="#提交订单后-Sku-何去何从" class="headerlink" title="提交订单后 Sku 何去何从"></a>提交订单后 <code>Sku</code> 何去何从</h3><p>在购物车选中 <code>sku</code> 提交订单之后，这些 <code>sku</code> 将从购物车移除。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://blog.csdn.net/u010647035/article/details/93384943" target="_blank" rel="noopener">Redis（十一）：重要版本一览</a></p>
<p><a href>Redis 设计与实现(第二版)</a></p>
<p><a href="http://www.redis.cn/" target="_blank" rel="noopener">Redis 中文官方网站</a></p>
<p><a href="http://www.redis.cn/commands/scan.html" target="_blank" rel="noopener">scan 命令</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>SpringBoot</code>的知识已经有前辈在我们之前探索了。比较喜欢的博主有：<a href="https://blog.battcn.com/" target="_blank" rel="noopener">唐亚峰 | Battcn</a>、<a href="https://blog.csdn.net/forezp" target="_blank" rel="noopener">方志朋的专栏</a>、<a href="http://blog.didispace.com/" target="_blank" rel="noopener">程序猿DD</a>、<a href="http://www.ityouknow.com/" target="_blank" rel="noopener">纯洁的微笑</a>。对这门技术感兴趣的可以去他们的博客逛逛。谢谢他们的分享~~</p>
<p>以上文章是我用来学习的<code>Demo</code>，都是基于 <code>SpringBoot2.x</code> 版本。</p>
<p><strong>源码地址:</strong> <a href="https://github.com/ynfatal/springboot2-learning/tree/master/chapter29" target="_blank" rel="noopener">https://github.com/ynfatal/springboot2-learning/tree/master/chapter29</a></p>

      
    </div>

    

    
    
    

    

    
      
    
    

    
      <div>
        




  



<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者:  </strong>Fatal</li>
  <li class="post-copyright-link">
    <strong>本文链接: </strong>
    
    <a href="https://ynfatal.github.io/2019/08/17/SpringBoot2/SpringBoot2第二十九篇Redis实现购物车/" title="SpringBoot2 | 第二十九篇：Redis 实现购物车">https://ynfatal.github.io/2019/08/17/SpringBoot2/SpringBoot2第二十九篇Redis实现购物车/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明:  </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li>
</ul>

      </div>
    

    <div>
      
        <div>
    
        <div style="margin-top: 40px;text-align:center;color: #ccc;font-size:14px;">
        -------------	end   -------------
        </div>
    
<div>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/SpringBoot2/" <i class="fa fa-tag"> SpringBoot2</a>
          
            <a href="/tags/Redis/" <i class="fa fa-tag"> Redis</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/06/11/linux/VirtualBox-Centos7安装/" rel="next" title="VirtualBox Centos7 安装">
                <i class="fa fa-chevron-left"></i> VirtualBox Centos7 安装
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/08/22/SpringBoot2/SpringBoot2第三十篇Redis实现热搜商品/" rel="prev" title="SpringBoot2 | 第三十篇：Redis 实现热搜商品">
                SpringBoot2 | 第三十篇：Redis 实现热搜商品 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </div></div></article>


  </div>


          </div>
          

  
    <div class="comments" id="gitalk-container">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="Fatal">
            
              <p class="site-author-name" itemprop="name">Fatal</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">49</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">8</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/ynfatal" title="GitHub &rarr; https://github.com/ynfatal" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:634137063@qq.com" title="E-Mail &rarr; mailto:634137063@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么选择-Redis-做购物车？"><span class="nav-text">为什么选择 Redis 做购物车？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#方案对比"><span class="nav-text">方案对比</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Mysql-方案"><span class="nav-text">Mysql 方案</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Redis-方案"><span class="nav-text">Redis 方案</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多规格的商品-Sku"><span class="nav-text">多规格的商品 Sku</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么选择-hash-来实现？"><span class="nav-text">为什么选择 hash 来实现？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#相关命令时间复杂度"><span class="nav-text">相关命令时间复杂度</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-底层编码-ziplist"><span class="nav-text">Redis 底层编码 ziplist</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hash-实现购物车"><span class="nav-text">hash 实现购物车</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#环境-版本一览："><span class="nav-text">环境/版本一览：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1、pom-xml"><span class="nav-text">1、pom.xml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、application-yml"><span class="nav-text">2、application.yml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、sql"><span class="nav-text">3、sql</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4、config"><span class="nav-text">4、config</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5、common"><span class="nav-text">5、common</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1、constants"><span class="nav-text">5.1、constants</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2、enums"><span class="nav-text">5.2、enums</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ResponseEnum-java"><span class="nav-text">ResponseEnum.java</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#StatusEnums-java"><span class="nav-text">StatusEnums.java</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3、exception"><span class="nav-text">5.3、exception</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4、handler"><span class="nav-text">5.4、handler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-5、utils"><span class="nav-text">5.5、utils</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6、entity"><span class="nav-text">6、entity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7、dto"><span class="nav-text">7、dto</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RedisTestDTO-java"><span class="nav-text">RedisTestDTO.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ShopCartDTO-java"><span class="nav-text">ShopCartDTO.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ShopCartSkuDTO-java"><span class="nav-text">ShopCartSkuDTO.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ShopCartItemDTO-java"><span class="nav-text">ShopCartItemDTO.java</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8、vo"><span class="nav-text">8、vo</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ShopCartVO-java"><span class="nav-text">ShopCartVO.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ShopCartItemVO-java"><span class="nav-text">ShopCartItemVO.java</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9、repository"><span class="nav-text">9、repository</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10、service"><span class="nav-text">10、service</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ISkuService-java"><span class="nav-text">ISkuService.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IShopCartService-java"><span class="nav-text">IShopCartService.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SkuServiceImpl-java"><span class="nav-text">SkuServiceImpl.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ShopCartServiceImpl-java"><span class="nav-text">ShopCartServiceImpl.java</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11、controller"><span class="nav-text">11、controller</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12、Application"><span class="nav-text">12、Application</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13、Test"><span class="nav-text">13、Test</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ShopCartServiceImplTest-java"><span class="nav-text">ShopCartServiceImplTest.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RedisTests"><span class="nav-text">RedisTests</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14、测试"><span class="nav-text">14、测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#说明"><span class="nav-text">说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化数据"><span class="nav-text">初始化数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#保存购物车"><span class="nav-text">保存购物车</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#进入购物车"><span class="nav-text">进入购物车</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#购物车列表"><span class="nav-text">购物车列表</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#首先看看第一页"><span class="nav-text">首先看看第一页</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#接着来看看第二页"><span class="nav-text">接着来看看第二页</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#看看最后一页"><span class="nav-text">看看最后一页</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#从购物车移除（部分种类商品）"><span class="nav-text">从购物车移除（部分种类商品）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#再测试下查询，看看数据是否正常"><span class="nav-text">再测试下查询，看看数据是否正常</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#清空购物车"><span class="nav-text">清空购物车</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#展示"><span class="nav-text">展示</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#临界值"><span class="nav-text">临界值</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查看-Redis-底层实现"><span class="nav-text">查看 Redis 底层实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#笔记"><span class="nav-text">笔记</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#问题：使用Json方式序列化和反序列化，LocalDateTime-没有无参构造怎么处理？"><span class="nav-text">问题：使用Json方式序列化和反序列化，LocalDateTime 没有无参构造怎么处理？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解决方式："><span class="nav-text">解决方式：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看-Redis-底层实现的命令"><span class="nav-text">查看 Redis 底层实现的命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-的增量式迭代"><span class="nav-text">Redis 的增量式迭代</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#提交订单后-Sku-何去何从"><span class="nav-text">提交订单后 Sku 何去何从</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-text">参考资料</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

      
      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heartbeat"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Fatal</span>

  

  
</div>


  <div class="powered-by">
    Total: <span id="busuanzi_value_site_pv"></span>  <!-- 本站总访问量 -->
    Visitors: <span id="busuanzi_value_site_uv"></span> <!-- 本站访客数 -->
    Hits: <span id="busuanzi_value_page_pv"></span> <!-- 本页总阅读量 -->
  </div>

  <!-- <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div> --> 








<!-- <div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共123k字</span>
</div> --> 

        








        
      </div>
    </footer>

    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  



  
    
    
  
  <script color="0,0,0" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>













  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script src="/js/utils.js?v=7.1.1"></script>

  <script src="/js/motion.js?v=7.1.1"></script>



  
  


  <script src="/js/affix.js?v=7.1.1"></script>

  <script src="/js/schemes/pisces.js?v=7.1.1"></script>




  
  <script src="/js/scrollspy.js?v=7.1.1"></script>
<script src="/js/post-details.js?v=7.1.1"></script>



  


  <script src="/js/next-boot.js?v=7.1.1"></script>


  

  

  

  


  
    

<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">



<script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>

<script>
  var gitalk = new Gitalk({
    clientID: '4dea51f0a84f2ec5b009',
    clientSecret: '0f278e2737f8e97d451299b4a91e29b735aa7633',
    repo: 'ynfatal.github.io',
    owner: 'ynfatal',
    admin: ['ynfatal'],
    id: md5(location.pathname),
    
      language: window.navigator.language || window.navigator.userLanguage,
    
    distractionFreeMode: 'true'
  });
  gitalk.render('gitalk-container');
</script>

  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').not('.gist .highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('Copied');
        else $(this).text('Copy failed');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('Copy');
      }, 300);
    }).append(e);
  })
</script>


  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":330},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>
</html>
